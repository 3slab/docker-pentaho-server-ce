define(["amd!../lib/underscore","./UnmanagedComponent","pentaho/data/Table","pentaho/visual/util","pentaho/shim/es6-promise"],function(i,s,e,t,n){"use strict";return s.extend({viz:null,__vizView:null,__vizClassesPromise:null,__vizClassesId:null,__vizStyleClass:null,update:function(){this.__checkVizType(),this.beginQuery(this.queryDefinition,this.__render)},__render:function(s){this.__checkVizType(),(this.viz?this.__syncVizAsync(s):this.__createVizAsync(s)).then(i.bind(this.__updateViz,this)).then(i.bind(this.endExec,this),i.bind(this.failExec,this))},_disposeCore:function(){this.__disposeViz()},_onGetVizSpec:function(i){},_onDidCreateViz:function(){},_onWillDisposeViz:function(){},__updateViz:function(){return this.viz.update()},__disposeViz:function(){this.viz&&(this._onWillDisposeViz(),this.__vizView&&(this.__vizView.dispose(),this.__vizView=null),this.viz=null)},__checkVizType:function(){this.__getVizClassesAsync().catch(function(){})},__getVizClassesAsync:function(){var i=this.vizId;if(!i)return n.reject(new Error("Visualization ID is not specified."));var s=this.__vizClassesId;return s&&s===i||(this.__disposeViz(),this.__vizClassesId=i,this.__vizClassesPromise=t.getModelAndDefaultViewClassesAsync(i)),this.__vizClassesPromise},__getVizSpec:function(s){var t={width:this.width,height:this.height};return void 0!==s&&(t.data=new e(s)),i.each(this.vizOptions,function(i){var s=i[0];switch(s){case"data":return}var e=i[1],n=this.getParameterValue(e);t[s]=n},this.dashboard),this._onGetVizSpec(t),t.isAutoUpdate=!0,t},__createVizAsync:function(s){return this.__getVizClassesAsync().then(i.bind(this.__onGotVizClasses,this,s))},__onGotVizClasses:function(i,s){this.__disposeViz();var e=this.__getVizSpec(i),t=new s.Model(e),n=this.__setupDomContainer(s.Model.type.id,s.viewTypeId);this.__vizView=new s.View({model:t,domContainer:n}),this.viz=t,this._onDidCreateViz()},__setupDomContainer:function(i,s){var e=this.placeholder().empty();null!=this.__vizStyleClass&&e.removeClass(this.__vizStyleClass);var n=this.__vizStyleClass=t.getCssClasses(i,s);return e.addClass(n),e[0]},__syncViz:function(i){var s=this.__getVizSpec(i);this.viz.configure(s)},__syncVizAsync:function(s){return new n(i.bind(function(i){this.__syncViz(s),i()},this))}})});