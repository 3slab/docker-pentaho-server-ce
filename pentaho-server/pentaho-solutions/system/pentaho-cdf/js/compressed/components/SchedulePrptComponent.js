define(["./SchedulePrptComponent.ext","./PrptComponent","../lib/jquery","amd!../lib/underscore","amd!../lib/jquery.impromptu","css!./theme/SchedulePrptComponent"],function(e,t,a,n){return t.extend({visible:!1,update:function(){var e=this,t=this.placeholder();t[0]&&a.inArray(t[0].tagName.toUpperCase(),["SPAN","DIV"])>-1&&(t=a("<button/>").appendTo(t.empty()),"DIV"==t[0].tagName&&t.wrap("<span/>"),void 0!=this.label&&t.text(this.label),t.button(),t.addClass("scheduler_button")),t.unbind("click"),t.bind("click",function(){(void 0===e.preChange||e.preChange())&&e.schedulePrptComponent(),void 0!==e.postChange&&e.postChange()})},createJobParameter:function(e,t,a,n,i){return n||void 0==this.getReportOptions()[e]?{name:e,stringValue:i?t:new Array(""+t),type:a}:{name:e,stringValue:i?this.getReportOptions()[e]:new Array(""+this.getReportOptions()[e]),type:a}},scheduleRequest:function(t){var i=this.outputTarget?this.outputTarget:"table/html;page-mode=page",r=new Array,o=0;r[o++]=this.createJobParameter("output-target",i,"string",!0),r[o++]=this.createJobParameter("accepted-page","0","string"),r[o++]=this.createJobParameter("showParameters","true","string"),r[o++]=this.createJobParameter("renderMode","XML","string"),r[o++]=this.createJobParameter("htmlProportionalWidth","false","string"),t&&(r[o++]=this.createJobParameter("_SCH_EMAIL_TO",a("#toInput").val(),"string"),r[o++]=this.createJobParameter("_SCH_EMAIL_CC","","string"),r[o++]=this.createJobParameter("_SCH_EMAIL_BCC","","string"),r[o++]=this.createJobParameter("_SCH_EMAIL_SUBJECT",a("#subjectInput").val(),"string"),r[o++]=this.createJobParameter("_SCH_EMAIL_MESSAGE",a("#messageInput").val(),"string"),r[o++]=this.createJobParameter("_SCH_EMAIL_ATTACHMENT_NAME",a("#attachmentNameInput").val(),"string"));for(var s=0;s<this.parameters.length;s++){var l=this.extractParameter(this.parameters[s]),p=n.isArray(l.value);r[o++]=this.createJobParameter(l.name,l.value,p?"string[]":"string",!0,p)}this.scheduleParameters=this.scheduleParameters||{},this.scheduleParameters.jobParameters=r;var d=!1;return a.ajax({url:e.getScheduledJob(),async:!1,type:"POST",data:JSON.stringify(this.scheduleParameters),contentType:"application/json",success:function(e){alert("Successfully scheduled."),d=!0,this.scheduleParameters={}},error:function(e){alert(e.responseText),d=!1,this.scheduleParameters={}}}),d},schedulePrptComponent:function(){this.scheduleParameters={};var t,n=!1,i=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"==e?t:3&t|8).toString(16)})},r=function(e,t){n=!0,a(t).css("backgroundColor","rgb(255,159,159)");var i=a(t).val();a(t).val(e),setTimeout(function(){a(t).css("backgroundColor","white"),a(t).val(i)},2e3)},o=function(){var e=x.path;return e.substring(e.lastIndexOf("/")+1,e.lastIndexOf("."))},s=function(){var e=a("#hours").val();return"pm"==a("#amPm").val()?24==(e=parseInt(e,10)+12)&&(e=12):"12"==e&&(e=0),e},l=function(e,t){var a=e.split("/");return t?new Date(a[2],a[0]-1,a[1],23,59,59,0).getTime():new Date(a[2],a[0]-1,a[1],0,0,0,0).getTime()},p=function(e){var t=e.split("/");return new Date(t[2],t[0]-1,t[1],0,0,0,0).toISOString()},d=function(e,t,a,n){for(var i='<select id ="'+n+'">',r=e;r<=t;r+=a)i+=r<10?'<option value="'+r+'">0'+r+"</option>":'<option value="'+r+'">'+r+"</option>";return i+="</select>"},u=function(e,t){var a=new Date;(isNaN(e)||e<a.getTime())&&r("Incorrect Date, pick date from calendar",t)},c=function(e,t){if(a("#endByRadio").is(":checked")){var n=new Date,i=a("#rangeStartIn").val(),o=l(i);isNaN(o)||(o>e?r("End Date > Start Date",t):(isNaN(e)||e<n.getTime())&&r("Incorrect Date",t))}},v=function(e){""==e&&r("You must choose a name","#nameIn");var t=/[^0-9a-zA-Z ]/;e.match(t)&&r("Invalid characters, alpha-numeric text only.","#nameIn")},y=function(e){var t,n=s(),i=a("#minutes").val(),r=6e4*i+36e5*n;return void 0!=e?(t=l(a(e).val())+r,u(t,e)):(t=l(a("#rangeStartIn").val())+r,u(t,"#rangeStartIn")),new Date(t).toISOString()},m=function(){var e=l(a("#endByIn").val(),!0);return c(e,"#endByIn"),new Date(e).toISOString()},h=function(){var e=new Array,t=0;return a("#sunday").is(":checked")&&(e[t++]=0),a("#monday").is(":checked")&&(e[t++]=1),a("#tuesday").is(":checked")&&(e[t++]=2),a("#wednesday").is(":checked")&&(e[t++]=3),a("#thursday").is(":checked")&&(e[t++]=4),a("#friday").is(":checked")&&(e[t++]=5),a("#saturday").is(":checked")&&(e[t++]=6),e},b=function(){var e=a("#recurrPatternIn").val();return e<1?r(">0","#recurrPatternIn"):e>31&&r("<=31","#recurrPatternIn"),e},f=function(){x.scheduleParameters={inputFile:x.path,jobName:a("#nameIn").val(),outputFile:a("#locationIn").val()},n=!1;var e=a("#recurrId").val(),t=a("#nameIn").val();switch(v(t),e){case"once":var i=y("#startDateIn"),o={repeatCount:0,repeatInterval:0,startTime:i,uiPassParam:"RUN_ONCE"};x.scheduleParameters.simpleJobTrigger=o;break;case"seconds":var i=y(),s=a("#recurrPatternInSec").val();if(s<1&&r(">0","#recurrPatternInSec"),a("#endByRadio").is(":checked"))var l=m();var o={endTime:l,repeatCount:-1,repeatInterval:s,startTime:i,uiPassParam:"SECONDS"};x.scheduleParameters.simpleJobTrigger=o;break;case"minutes":var i=y(),d=a("#recurrPatternInMin").val();if(d<1&&r(">0","#recurrPatternInMin"),a("#endByRadio").is(":checked"))var l=m();var o={endTime:l,repeatCount:-1,repeatInterval:60*d,startTime:i,uiPassParam:"MINUTES"};x.scheduleParameters.simpleJobTrigger=o;break;case"hours":var i=y(),u=a("#recurrPatternInHour").val();if(u<1&&r(">0","#recurrPatternInHour"),a("#endByRadio").is(":checked"))var l=m();var o={endTime:l,repeatCount:-1,repeatInterval:3600*u,startTime:i,uiPassParam:"HOURS"};x.scheduleParameters.simpleJobTrigger=o;break;case"daily":if(a("#endByRadio").is(":checked"))var l=m();var i=y();if(a("#weekDayRadio").is(":checked")){var c={daysOfWeek:[1,2,3,4,5],endTime:l,startTime:i,uiPassParam:"DAILY"};x.scheduleParameters.complexJobTrigger=c}else if(a("#dayRadio").is(":checked")){var f=a("#recurrPatternInDay").val();f<1&&r(">0","#recurrPatternInDay");var o={entTime:l,repeatCount:-1,repeatInterval:86400*f,startTime:i,uiPassParam:"DAILY"};x.scheduleParameters.simpleJobTrigger=o}break;case"weekly":var i=y();if(a("#endByRadio").is(":checked"))var l=m();var c={daysOfWeek:h(),endTime:l,startTime:i,uiPassParam:"WEEKLY"};x.scheduleParameters.complexJobTrigger=c;break;case"monthly":var i=y();if(a("#endByRadio").is(":checked"))var l=m();var c={endTime:l,startTime:i,uiPassParam:"MONTHLY"};a("#monthRadio").is(":checked")?c.daysOfMonth=b():(c.daysOfWeek=a("#monthOpt2Select").val(),c.weeksOfMonth=a("#monthOpt1Select").val()),x.scheduleParameters.complexJobTrigger=c;break;case"yearly":var i=y();if(a("#endByRadio").is(":checked"))var l=m();var c={endTime:l,startTime:i,uiPassParam:"YEARLY"};a("#yearRadio").is(":checked")?(c.daysOfMonth=b(),c.monthsOfYear=a("#yearEveryMonth").val()):(c.daysOfWeek=a("#yearOpt2Select").val(),c.monthsOfYear=a("#yearMonthSelect").val(),c.weeksOfMonth=a("#yearOpt1Select").val()),x.scheduleParameters.complexJobTrigger=c;break;case"cron":var k=a("#cronString").val();g(k);var i=p(a("#rangeStartIn").val());a("#endByRadio").is(":checked")&&(l=m());var w={cronString:k,endTime:l,startTime:i,uiPassParam:"CRON"};x.scheduleParameters.cronJobTrigger=w}},g=function(e){var t=e.split(" ");t.length<7?r("Cron Expression too short","#cronString"):t.length>7?r("Cron Expression too long","#cronString"):"?"!=t[3]&&"*"!=t[3]&&"?"!=t[5]&&"*"!=t[5]&&r("M+W unsupported.(M+? or W+?)","#cronString")},k=function(){a("#rangeOfRecurrDiv").hide(),a("#cronDiv").hide(),a("#recurrPatternDiv").hide(),a("#startTimeDiv").hide(),a("#rangeOfRecurrOnceDiv").hide(),a("#patternSec").hide(),a("#patternMin").hide(),a("#patternHour").hide(),a("#patternDay").hide(),a("#patternWeek").hide(),a("#patternMonth").hide(),a("#patternYear").hide()},w=function(){var e=a("#recurrId").val();switch(k(),e){case"once":a("#startTimeDiv").show(),a("#rangeOfRecurrOnceDiv").show();break;case"seconds":a("#startTimeDiv").show(),a("#recurrPatternDiv").show(),a("#patternSec").show(),a("#rangeOfRecurrDiv").show();break;case"minutes":a("#startTimeDiv").show(),a("#recurrPatternDiv").show(),a("#patternMin").show(),a("#rangeOfRecurrDiv").show();break;case"hours":a("#startTimeDiv").show(),a("#recurrPatternDiv").show(),a("#patternHour").show(),a("#rangeOfRecurrDiv").show();break;case"daily":a("#startTimeDiv").show(),a("#recurrPatternDiv").show(),a("#patternDay").show(),a("#rangeOfRecurrDiv").show();break;case"weekly":a("#startTimeDiv").show(),a("#recurrPatternDiv").show(),a("#patternWeek").show(),a("#rangeOfRecurrDiv").show();break;case"monthly":a("#startTimeDiv").show(),a("#recurrPatternDiv").show(),a("#patternMonth").show(),a("#rangeOfRecurrDiv").show();break;case"yearly":a("#startTimeDiv").show(),a("#recurrPatternDiv").show(),a("#patternYear").show(),a("#rangeOfRecurrDiv").show();break;case"cron":a("#cronDiv").show(),a("#rangeOfRecurrDiv").show()}},x=this,P='<div id="nameDiv"><form style="display:inline-block" id="nameForm"><span class="dialog-label">Name:</span><input id="nameIn" type="text" value="'+o()+'"></form></div>',D='<div id="locationDiv"><form style="display:inline-block" id="nameForm"><span class="dialog-label">Location:</span><input id="locationIn" type="text" value="'+function(){return"/home/"+x.dashboard.context.user}()+'"></form></div>',I=d(1,12,1,"hours"),S=d(0,59,1,"minutes"),T='<div id="startTimeDiv"><br><span class="dialog-title" style="width: 100px; display: inline-block;">Start Time:</span>'+I+S+'<select id = "amPm"><option value="am">AM</option><option value="pm">PM</option></select></div>',O='<div id="mailInfoDiv" style="display:none"><label>To: (Use a semi-colon or comma to separate multiple email adresses.)</label><form><input id="toInput" style="width:100%" type="text"></input></form><label>Subject:</label><form><input id="subjectInput" style="width:100%" type="text" value="'+o()+' schedule has successfully run."></input></form><label>Attachment Name:</label><form><input id="attachmentNameInput" style="width:100%" type="text" value="'+a("#nameIn").val()+'"></input></form><label>Message (optional)</label><textarea id="messageInput" type="text" rows="4" style="width:100%"></textarea></div>',R=P+D+'<div id = "recurrenceDiv"><br><span class="dialog-title" style="width: 100px; display: inline-block;">Recurrence:</span><select id="recurrId" style="margin-left: 0px;"><option value = "once" selected>Run Once</option><option value = "seconds">Seconds</option><option value = "minutes">Minutes</option><option value = "hours">Hours</option><option value = "daily">Daily</option><option value = "weekly">Weekly</option><option value = "monthly">Monthly</option><option value = "yearly">Yearly</option><option value = "cron">Cron</option></select></br></div><div id="cronDiv"  style="display:none"><form><span class="dialog-label">Cron String:</span><input id="cronString" type="text" value=""></form></div>'+T+'<div id="recurrPatternDiv" style = "display:none"><div id="patternSec" ><label style="display:inline-block; margin-left: 100px; font-weight: 500;">Every</label>&nbsp;&nbsp;<form style="display:inline-block"><input id= "recurrPatternInSec" type="text" size="3" style="width:30px;"></form><label style="display:inline-block; font-weight: 500;"> second(s)</label></div><div id="patternMin" ><label style="display:inline-block; margin-left: 100px; font-weight: 500;">Every</label>&nbsp;&nbsp;<form style="display:inline-block"><input id= "recurrPatternInMin" type="text" size="3" style="width:30px;"></form><label style="display:inline-block; font-weight: 500;"> minute(s)</label></div><div id="patternHour" ><label style="display:inline-block; margin-left: 100px; font-weight: 500;">Every</label>&nbsp;&nbsp;<form style="display:inline-block"><input id= "recurrPatternInHour" type="text" size="3" style="width:30px;"></form><label style="display:inline-block; font-weight: 500;"> hour(s)</label></div><div id="patternDay" ><input type="radio" name ="day" value="day" id="dayRadio" style="margin-left: 100px; font-weight: 500;" checked> <label style="display:inline-block">Every</label>&nbsp;&nbsp;<form style="display:inline-block"><input id= "recurrPatternInDay" type="text" size="3" style="width:30px;"></form><label style="display:inline-block; font-weight: 500;"> day(s)</label></br><input type="radio" name ="day" value="weekDay" id="weekDayRadio" style="margin-left: 100px;"> Every weekday</div><div id="patternWeek" ><form><div id="errorCheckboxes" style="display:none"><label id="errWeek">Choose at least one week</label></div><input type="checkbox" name="weekday" value="monday" id="monday" style="margin-left: 100px;"> Monday<input type="checkbox" name="weekday" value="tuesday" id="tuesday"> Tuesday<input type="checkbox" name="weekday" value="wednesday" id="wednesday"> Wednesday<input type="checkbox" name="weekday" value="thursday" id="thursday"> Thursday</br><input type="checkbox" name="weekday" value="friday" id="friday" style="margin-left: 100px;"> Friday<input type="checkbox" name="weekday" value="saturday" id="saturday"> Saturday<input type="checkbox" name="weekday" value="sunday" id="sunday"> Sunday</form></div><div id="patternMonth" ><input id="monthRadio" type="radio" name ="month" value="day" style="margin-left: 100px;" checked> <label style="display:inline-block; font-weight: 500;">Day</label>&nbsp;&nbsp;<form style="display:inline-block"><input id= "recurrPatternIn" type="text" size="3" style="width:205px;"></form><label style="display:inline-block; font-weight: 500;"> of every month</label></br><input type="radio" name ="month" value="the" style="margin-left: 100px;"> <label style="display:inline-block; font-weight: 500;">The</label>&nbsp;&nbsp;<select id="monthOpt1Select"><option value="0">first</option><option value="1">second</option><option value="2">third</option><option value="3">fourth</option><option value="4">last</option></select><select id="monthOpt2Select"><option value="0">sunday</option><option value="1">monday</option><option value="2">tuesday</option><option value="3">wednesday</option><option value="4">thursday</option><option value="5">friday</option><option value="6">saturday</option></select><label style=" font-weight: 500;"> of every month</label></div><div id="patternYear" ><input id ="yearRadio" type="radio" name ="year" value="month" style="margin-left: 100px;" checked> <label style="display:inline-block; font-weight: 500;">Every</label>&nbsp;<select id="yearEveryMonth"><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option></select><input id="yearDayMonth"type="text" size="3"></br><input type="radio" name ="year" value="the" style="margin-left: 100px;"> <label style="display:inline-block; font-weight: 500;">The</label>&nbsp;<select id="yearOpt1Select"><option value="0">first</option><option value="1">second</option><option value="2">third</option><option value="3">fourth</option><option value="4">last</option></select><select id="yearOpt2Select"><option value="0">sunday</option><option value="1">monday</option><option value="2">tuesday</option><option value="3">wednesday</option><option value="4">thursday</option><option value="5">friday</option><option value="6">saturday</option></select><label style=" font-weight: 500;">of&nbsp;&nbsp;</label><select id="yearMonthSelect"><option value="0">January</option><option value="1">February</option><option value="2">March</option><option value="3">April</option><option value="4">May</option><option value="5">June</option><option value="6">July</option><option value="7">August</option><option value="8">September</option><option value="9">October</option><option value="10">November</option><option value="11">December</option></select></div></div><div id="rangeOfRecurrDiv" style="display:none"><br><span class="dialog-title"><strong>Range of Recurrence:</strong> </span><form><span class="dialog-label">Start:</span><input type="text" id="rangeStartIn"></form><form><span class="dialog-label">End:</span><input type="radio" name ="end" value="noEnd" checked> No end date</br><input type="radio" name ="end" value ="endBy" id="endByRadio" style="margin-left:100px;"> End by:&nbsp;&nbsp;<input id= "endByIn" type="text" style="width:187px;"></form></div><div id="rangeOfRecurrOnceDiv"><form><span class="dialog-label">Start Date:</span><input id= "startDateIn" type="text" value=""></form></div>',M='<div id="mailQuestionDiv"><label>Would you like to email a copy when the schedule runs?</label><br><input type="radio" name="mailRadio" value="no" id="mailRadioNo" checked onclick=\'showHideMailDiv()\'>&nbsp;No&nbsp;&nbsp;</input><input type="radio" name="mailRadio" value="yes" id="mailRadioYes" onclick=\'showHideMailDiv(true)\'>&nbsp;Yes&nbsp;&nbsp;</input></div>'+O,C=!1;a.ajax({type:"GET",url:e.getEmailConfig()+"/isValid",success:function(e){C=e}});var E={basicState:{html:R,title:"Schedule Report",buttons:{Cancel:-1,Ok:1},submit:function(e,r,o,s){if(t=i(),-1==r)a.prompt.close();else if(1==r)return f(),n?(parameters={},!1):C?(a("#attachmentNameInput").val(a("#nameIn").val()),a.prompt.goToState("mailState"),!1):x.scheduleRequest()}},mailState:{html:M,title:"Schedule Report",buttons:{Back:-1,Ok:1},submit:function(e,t,n,i){if(-1==t)return a.prompt.goToState("basicState"),!1;if(1==t){if(a("#mailRadioNo").is(":checked"))return x.scheduleRequest();if(a("#mailRadioYes").is(":checked")){var o=/^\S+@\S+$/;return a("#toInput").val().match(o)?x.scheduleRequest(!0):(r("Invalid email","#toInput"),!1)}return!1}}}};a.prompt(E,{box:"scheduler",loaded:function(){a("#recurrId").on("change",function(){w()})}}),a(".scheduler #jqi").css("width","510px"),a(document).ready(function(e){a("#startDateIn").datepicker({minDate:0}),a("#rangeStartIn").datepicker({minDate:0}),a("#endByIn").datepicker({minDate:0}),a("#startDateIn").datepicker("setDate",new Date),a("#rangeStartIn").datepicker("setDate",new Date)})}})});