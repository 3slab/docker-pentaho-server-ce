define(["../Logger","./UnmanagedComponent","amd!../lib/underscore","../lib/jquery","css!./theme/AutocompleteBoxComponent"],function(e,t,i,s){return t.extend({constructor:function(){this.base.apply(this,arguments),this.selectedValues=[]},result:[],_queryServer:function(t,s){this.parameters||(this.parameters=[]),i.isString(t)&&(this.searchParam=t),this.searchParam&&this.parameters.push([this.searchParam,this._getInnerParameterName()]),this.maxResults&&(this.queryDefinition.pageSize=this.maxResults),this.dashboard.setParameter(this._getInnerParameterName(),this._getTextBoxValue()),this.queryDefinition?this.triggerQuery(this.queryDefinition,s):e.error("No query definition found")},_getTextBoxValue:function(){return this.textbox.val()},_getInnerParameterName:function(){return this.parameter+"_textboxValue"},_setInitialValue:function(){var e=this.parameter,t=null;if(e&&(t=this.dashboard.getParameterValue(e)),null!=t&&i.isArray(t))for(var s=0,a=t.length;s<a;s++)this._selectValue(t[s])},update:function(){if(this.lifecycle?this.lifecycle.silent=!0===this.silent:this.lifecycle={silent:!0===this.silent},this.preExec()){if(this.isSilent()||this.block(),this.ph=this.placeholder().empty(),0===this.ph.length)return e.warn("Placeholder not in DOM - Will not draw"),!1;this.defaultParameters=i.isArray(this.parameters)?this.parameters.slice():[];var t=this;i.isFunction(this.processChange)||(this.processChange=function(){t.value=t.selectedValues,t.dashboard.processChange(t.name)});var a=this.selectMulti||!1;this.dashboard.getParameterValue(this._getInnerParameterName())||this.dashboard.setParameter(this._getInnerParameterName(),""),this.textbox=s('<input class="autocomplete-input">');var n=s('<div class="autocomplete-container">');if(a){var o=this.tooltipMessage||"Click it to Apply",l=s('<input type="button" class="autocomplete-input-apply" style="display: none" title="'+o+'" value="'+(this.submitLabel||"S")+'"/>').click(function(){t._endSearch()});n.append(l)}n.append(this.textbox).append('<ul class="list-data-selection">').appendTo(this.ph),this.textbox.autocomplete(this._getOptions()),this.ph.find(".autocomplete-container .ui-autocomplete").off("menuselect"),this.ph.find(".autocomplete-container .ui-autocomplete").on("menuselect",function(e,i){var n=i?i.item.find("input"):s(e.target).find("input");n.length>0&&n.prop("checked",!n.is(":checked"));var o=i?i.item.find("a").text():s(e.target).text();a?n.is(":checked")?t._selectValue(o):t._removeValue(o):(t._selectValue(o),t._endSearch())}),this.textbox.data("ui-autocomplete")._renderItem=function(e,t){var i=s('<li class="list-item">'),n=s("<a>"+t.label+"</a>");return a&&s('<input type="checkbox"/>').click(function(){s(this).parent().trigger("menuselect")}).prependTo(n),n.appendTo(i),i.appendTo(e)},this.ph.find("#"+this.externalApplyButtonId).click(function(){t._endSearch()}),this._setInitialValue(),this.postExec(),this.isSilent()||this.unblock()}},getValue:function(){return this.value},_unlink:function(){this.base(),this.ph=null},_getOptions:function(){var e=this;return{appendTo:this.ph.find(".autocomplete-container"),minLength:this.minTextLength||0,source:function(t,i){e._search(t,i)},focus:function(e,t){e.preventDefault()},open:function(t,i){var s=e.scrollHeight||0;s>0&&e.ph.find(".autocomplete-container .ui-autocomplete").css({"max-height":s+"px","overflow-y":"auto"}),e._filterData()},close:function(t,i){e.processChange()}}},_selectValue:function(e){var t=this,i=null==this.addTextElements||this.addTextElements,a=null==this.showApplyButton||this.showApplyButton,n=this.ph.find(".autocomplete-container .list-data-selection"),o=s('<li id="'+e+'"><input type="button" class="close-button" value="x"/>'+e+"</li>");this.selectMulti?a&&(this.ph.find(".autocomplete-container").addClass("show-apply-button"),this.ph.find(".autocomplete-input-apply").show()):(n.empty(),this.selectedValues=[]),o.find("input").click(function(){t._removeValue(e,!0)}),i&&o.appendTo(n),this.selectedValues.push(e)},_removeValue:function(e,t){this.selectedValues=i.without(this.selectedValues,e),this.ph.find('.autocomplete-container .list-data-selection li[id="'+e+'"]').remove(),t&&this.processChange()},_filterData:function(){var e=this.ph.find(".autocomplete-container .ui-autocomplete"),t=this.selectedValues||[],i=null==this.addTextElements||this.addTextElements;t.length>0&&(e.find("li").each(function(){var e=s(this),a=e.text();t.indexOf(a)>-1&&(i?e.remove():e.find("input").prop("checked",!0))}),0==e.find("li").length&&e.hide())},_search:function(e,t){var i=this.matchType||"fromStart",s=e.term.toLowerCase(),a=this;this._queryServer(s,function(e){a.parameters=a.defaultParameters.slice();var n=e.resultset?e.resultset:e,o=[];for(var l in n)if(n.hasOwnProperty(l)){var r=n[l][0];(null!=r&&"fromStart"===i&&0==r.toLowerCase().indexOf(s)||"all"===i&&r.toLowerCase().indexOf(s)>-1)&&o.push(r)}t(o)})},_endSearch:function(){var e=this.ph.find(".autocomplete-container");e.removeClass("show-apply-button"),e.find(".autocomplete-input-apply").hide(),this.textbox.val(""),this.textbox.autocomplete("close")},_processAutoBoxChange:function(){this.textbox.autocomplete("change")}})});