/*!
* Copyright 2010 - 2017 Hitachi Vantara.  All rights reserved.
*
* Licensed under the Apache License, Version 2.0 (the "License");
* you may not use this file except in compliance with the License.
* You may obtain a copy of the License at
*
* http://www.apache.org/licenses/LICENSE-2.0
*
* Unless required by applicable law or agreed to in writing, software
* distributed under the License is distributed on an "AS IS" BASIS,
* WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
* See the License for the specific language governing permissions and
* limitations under the License.
*
*/

define(["cdf/lib/CCC/def","cdf/lib/CCC/pvc","common-ui/vizapi/VizController","pentaho/common/Messages","dojo/_base/declare","dojo/_base/array"],function(e,t,i,a,n,r){pentaho="undefined"!=typeof pentaho?pentaho:{},pentaho.visualizations||(pentaho.visualizations={}),analyzerPlugins="undefined"==typeof analyzerPlugins?[]:analyzerPlugins,analyzerPlugins.push({init:function(){n("analyzer.CCCVizHelper",null,{isInteractionEnabled:function(){return!0},hasContentLink:function(){return/\bcl=/.test(window.location.href)},showConfirm:function(e,t){t&&cv.prefs.suppressMsg[t]||cv.getActiveReport().rptDlg.showConfirm(e,null,null,null,t)},message:function(e,t){var i=cvCatalog[e]||"";return i&&t&&(i=cv.util.substituteParams.apply(cv.util,[i].concat(t))),i},getDoubleClickTooltip:function(e){return cv.getActiveReport().getDoubleClickTooltip(e)},completeAxisGemsMetadata:function(t,i){function a(e,t){return parseFloat(e.getAttribute("gembarOrdinal"))-parseFloat(t.getAttribute("gembarOrdinal"))}function n(t){var i="[@gembarId='"+t+"']";i=u?"cv:measures/cv:measure"+i:"cv:columnAttributes/cv:attribute"+i+" | cv:rowAttributes/cv:attribute"+i;var n=s.selectNodes(i);return n=e.query(n).array(),n.sort(a),n}function o(t){var i=e.getOwn(l,t);i||(i=l[t]=n(t));for(var a;i.length&&(a=i.shift(),"true"===a.getAttribute("hideInChart")););return a}var s=cv.getActiveReport().reportDoc.getReportNode(),c=cv.getFieldHelp(),u="measure"===t,l={};r.forEach(i,function(t){var i=t.role;if(i&&"undefined"!==i){var a,n,r,s,l,d=o(t.role)||e.assert("Undefined gem in document."),h=d.getAttribute("formula")||null,g=!1;switch(d.parentNode.tagName){case"rowAttributes":l="row";break;case"columnAttributes":l="column";break;case"measures":l="measure"}if(u&&(n="[Measures]",t.measureType=d.getAttribute("measureTypeEnum")),u&&"VALUE"!==t.measureType)a=d.getAttribute("id"),h=null,g=!1;else{var p=cv.getActiveReport().getGem(h)||e.assert("No gem object.");a=p.getUniqueId(),t.label=p.getDisplayLabel(!0);var f=p.getLink&&p.getLink();g=!!f,r=g?f.getAttribute("toolTip"):null,s=g?f.getAttribute("type"):null,u||(h||e.assert("Non-measures have formulas."),n=c.get(h,"hierarchy"))}e.set(t,"id",a,"formula",h,"hierarchy",n,"hasLink",g,"linkLabel",r||"","linkType",s,"reportAxis",l)}})},generateOptionsFromAnalyzerState:function(e){for(var t={},i=e.reportDoc.getChartOptions().attributes,a=0;a<i.length;a++){var n=i[a];switch(n.nodeName){case"lineShape":case"lineWidth":case"scatterPattern":case"scatterColorSet":case"scatterReverseColors":break;default:t[n.nodeName]=n.nodeValue}}return t},canRefreshReport:function(e){for(var t=e.getVizDataReq(),i=0;i<t.length;i++)if(1==t[i].required&&0==e.findGemsByGembarId(t[i].id).length)return!1;switch(e.visualization.id){case"ccc_heatgrid":return e.findGemsByGembarId("color").length>0||e.findGemsByGembarId("size").length>0;case"ccc_barline":return e.findGemsByGembarId("measures").length>0||e.findGemsByGembarId("measuresLine").length>0}return!0}}),n("analyzer.CCCVizConfig",[analyzer.ColorConfiguration],{_processModelValueChange:function(e,t){this.report.visualization.args[e.id]=t.newVal},onModelEvent:function(e,t,i,a){"value"==i&&this._processModelValueChange(t,a),this.inherited(arguments)},updateConfiguration:function(e){this.inherited(arguments);var t=this.report.visualization.args;if(r.forEach(e.properties,function(e){if(!e.dataStructure){var i=e.value;if(void 0===i){var a=e.values;a&&a.length&&(i=a[0])}void 0!==i&&(t[e.id]=i)}},this),!t.colorScaleType){e.byId("pattern")&&this._updateColorConfiguration(e)}this._updateTrendUI(e)},_updateColorConfiguration:function(e){var t,i=e.byId("pattern").value,a=e.byId("colorSet").value,n="";"GRADIENT"==i?(t="linear",n="-5"):(n="3-COLOR"==i?"-3":"-5",t="discrete"),this._setScalingType(t);var r=e.byId("reverseColors").value,o=this.palettes[a+n];if(r){for(var s=[],c=o.length-1;c>=0;c--)s.push(o[c]);o=s}this._setColorRange(o)},_updateTrendUI:function(e){var t=e.byId("trendType");if(t){var i=t.value,a=!i||"none"===i;e.byId("trendLineWidth").ui.hidden=a,e.byId("trendName").ui.hidden=a}},_setScalingType:function(e){this.report.visualization.args.colorScaleType=e},_setColorRange:function(e){this.report.visualization.args.colors=e}}),n("analyzer.CCCHeatgridVizConfig",[analyzer.CCCVizConfig],{onModelEvent:function(e,t,i,a){switch(i){case"insertAt":case"gems":this._updateOptions(e)}this.inherited(arguments)},updateConfiguration:function(e){this._updateOptions(e),this.inherited(arguments)},_updateOptions:function(e){var t=e.byId("color"),i=e.byId("size"),a=t.gems.length+i.gems.length;t.required=0==a,i.required=0==a}}),n("analyzer.CCCBarLineVizConfig",[analyzer.CCCVizConfig],{onModelEvent:function(e,t,i,a){switch(i){case"insertAt":case"gems":this._updateMeasuresOptions(e)}this.inherited(arguments)},updateConfiguration:function(e){this._updateMeasuresOptions(e),this.inherited(arguments)},_updateMeasuresOptions:function(e){var t=e.byId("measures"),i=e.byId("measuresLine"),a=t.gems.length+i.gems.length;t.required=0==a,i.required=0==a;var n=i.gems.length>0;["shape","lineWidth"].forEach(function(t){e.byId(t).ui.hidden=!n})}}),n("analyzer.CCCScatterVizConfig",[analyzer.CCCVizConfig],{onModelEvent:function(e,t,i,a){switch(i){case"insertAt":case"gems":this._updateColorRoleOptions(e)}this.inherited(arguments)},updateConfiguration:function(e){this._updateColorRoleOptions(e),this.inherited(arguments)},_updateColorRoleOptions:function(e){var t=e.byId("color");t.allowMultiple=!t.gems.length||"measure"!==t.gems[0].type;var i=t.gems.length>0&&"measure"===t.gems[0].type;e.byId("reverseColors").ui.hidden=!i,e.byId("colorSet").ui.hidden=!i,e.byId("pattern").ui.hidden=!i}});var t=["ccc_bar","ccc_barstacked","ccc_barnormalized","ccc_horzbar","ccc_horzbarstacked","ccc_horzbarnormalized","ccc_pie","ccc_line","ccc_area","ccc_scatter","ccc_barline","ccc_heatgrid","ccc_sunburst"],i={ccc_heatgrid:analyzer.CCCHeatgridVizConfig,ccc_scatter:analyzer.CCCScatterVizConfig,ccc_barline:analyzer.CCCBarLineVizConfig},a=new analyzer.CCCVizHelper;cv.pentahoVisualizations||(cv.pentahoVisualizations=[]),cv.pentahoVisualizationsHelpers||(cv.pentahoVisualizationsHelpers={}),r.forEach(t,function(e){cv.pentahoVisualizations.push(pentaho.visualizations.getById(e)),cv.pentahoVisualizationHelpers[e]=a,analyzer.LayoutPanel.configurationManagers["JSON_"+e]=i[e]||analyzer.CCCVizConfig},this)}})});