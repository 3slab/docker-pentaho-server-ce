define(["../_base/kernel","../_base/lang","../when","../_base/array"],function(e,t,n,r){var i=function(e){function i(t,r){var i=e[t];i&&(e[t]=function(e){if(u)return i.apply(this,arguments);u=!0;try{var t=i.apply(this,arguments);return n(t,function(t){r("object"==typeof t&&t||e)}),t}finally{u=!1}})}var o=[],a=0;e=t.delegate(e),e.notify=function(e,t){a++;for(var n=o.slice(),r=0,i=n.length;r<i;r++)n[r](e,t)};var f=e.query;e.query=function(i,u){u=u||{};var c=f.apply(this,arguments);if(c&&c.forEach){var s=t.mixin({},u);delete s.start,delete s.count;var l,v=e.queryEngine&&e.queryEngine(i,s),y=a,d=[];c.observe=function(t,i){1==d.push(t)&&o.push(l=function(t,o){n(c,function(n){var f,c,s,l=n.length!=u.count;if(++y!=a)throw new Error("Query is out of date, you must observe() the query prior to any data modifications");var h,p=-1,g=-1;if(void 0!==o)for(f=0,c=n.length;f<c;f++){var b=n[f];if(e.getIdentity(b)==o){h=b,p=f,!v&&t||n.splice(f,1);break}}if(v){if(t&&(v.matches?v.matches(t):v([t]).length)){var m=p>-1?p:n.length;n.splice(m,0,t),g=r.indexOf(v(n),t),n.splice(m,1),u.start&&0==g||!l&&g==n.length?g=-1:n.splice(g,0,t)}}else t&&(void 0!==o?g=p:u.start||(g=e.defaultIndex||0,n.splice(g,0,t)));if((p>-1||g>-1)&&(i||!v||p!=g)){var q=d.slice();for(f=0;s=q[f];f++)s(t||h,p,g)}})});var f={};return f.remove=f.cancel=function(){var e=r.indexOf(d,t);e>-1&&(d.splice(e,1),d.length||o.splice(r.indexOf(o,l),1))},f}}return c};var u;return i("put",function(t){e.notify(t,e.getIdentity(t))}),i("add",function(t){e.notify(t)}),i("remove",function(t){e.notify(void 0,t)}),e};return t.setObject("dojo.store.Observable",i),i});