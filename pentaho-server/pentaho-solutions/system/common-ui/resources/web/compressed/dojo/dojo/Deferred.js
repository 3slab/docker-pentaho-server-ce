define(["./has","./_base/lang","./errors/CancelError","./promise/Promise","./has!config-deferredInstrumentation?./promise/instrumentation"],function(e,r,n,t,i){"use strict";var c="This deferred has already been fulfilled.",o=Object.freeze||function(){},u=function(r,n,t,i,c){e("config-deferredInstrumentation")&&2===n&&l.instrumentRejected&&0===r.length&&l.instrumentRejected(t,!1,i,c);for(var o=0;o<r.length;o++)s(r[o],n,t,i)},s=function(r,n,t,i){var c=r[n],o=r.deferred;if(c)try{var u=c(t);if(0===n)void 0!==u&&a(o,n,u);else{if(u&&"function"==typeof u.then)return r.cancel=u.cancel,void u.then(f(o,1),f(o,2),f(o,0));a(o,1,u)}}catch(e){a(o,2,e)}else a(o,n,t);e("config-deferredInstrumentation")&&2===n&&l.instrumentRejected&&l.instrumentRejected(t,!!c,i,o.promise)},f=function(e,r){return function(n){a(e,r,n)}},a=function(e,r,n){if(!e.isCanceled())switch(r){case 0:e.progress(n);break;case 1:e.resolve(n);break;case 2:e.reject(n)}},l=function(r){var i,f,a,d=this.promise=new t,h=this,m=!1,p=[];e("config-deferredInstrumentation")&&Error.captureStackTrace&&(Error.captureStackTrace(h,l),Error.captureStackTrace(d,l)),this.isResolved=d.isResolved=function(){return 1===i},this.isRejected=d.isRejected=function(){return 2===i},this.isFulfilled=d.isFulfilled=function(){return!!i},this.isCanceled=d.isCanceled=function(){return m},this.progress=function(e,r){if(i){if(!0===r)throw new Error(c);return d}return u(p,0,e,null,h),d},this.resolve=function(e,r){if(i){if(!0===r)throw new Error(c);return d}return u(p,i=1,f=e,null,h),p=null,d};var v=this.reject=function(r,n){if(i){if(!0===n)throw new Error(c);return d}return e("config-deferredInstrumentation")&&Error.captureStackTrace&&Error.captureStackTrace(a={},v),u(p,i=2,f=r,a,h),p=null,d};this.then=d.then=function(e,r,n){var t=[n,e,r];return t.cancel=d.cancel,t.deferred=new l(function(e){return t.cancel&&t.cancel(e)}),i&&!p?s(t,i,f,a):p.push(t),t.deferred.promise},this.cancel=d.cancel=function(e,t){if(i){if(!0===t)throw new Error(c)}else{if(r){var o=r(e);e=void 0===o?e:o}if(m=!0,!i)return void 0===e&&(e=new n),v(e),e;if(2===i&&f===e)return e}},o(d)};return l.prototype.toString=function(){return"[object Deferred]"},i&&i(l),l});