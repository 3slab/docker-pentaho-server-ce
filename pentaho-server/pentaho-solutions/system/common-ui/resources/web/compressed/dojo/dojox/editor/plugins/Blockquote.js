define(["dojo","dijit","dojox","dijit/_editor/_Plugin","dijit/form/ToggleButton","dojo/_base/connect","dojo/_base/declare","dojo/i18n","dojo/i18n!dojox/editor/plugins/nls/Blockquote"],function(e,t,i,n){var o=e.declare("dojox.editor.plugins.Blockquote",n,{iconClassPrefix:"dijitAdditionalEditorIcon",_initButton:function(){this._nlsResources=e.i18n.getLocalization("dojox.editor.plugins","Blockquote"),this.button=new t.form.ToggleButton({label:this._nlsResources.blockquote,showLabel:!1,iconClass:this.iconClassPrefix+" "+this.iconClassPrefix+"Blockquote",tabIndex:"-1",onClick:e.hitch(this,"_toggleQuote")})},setEditor:function(e){this.editor=e,this._initButton(),this.connect(this.editor,"onNormalizedDisplayChanged","updateState"),e.customUndo=!0},_toggleQuote:function(i){try{var n=this.editor;n.focus();var o,a,s,r,l=this.button.get("checked"),d=t.range.getSelection(n.window);if(d&&d.rangeCount>0&&(o=d.getRangeAt(0)),o){if(n.beginEditing(),l){var c,h;if(o.startContainer===o.endContainer){if(this._isRootInline(o.startContainer)){for(s=o.startContainer;s&&s.parentNode!==n.editNode;)s=s.parentNode;for(;s&&s.previousSibling&&(this._isTextElement(s)||1===s.nodeType&&this._isInlineFormat(this._getTagName(s)));)s=s.previousSibling;if(s&&1===s.nodeType&&!this._isInlineFormat(this._getTagName(s))&&(s=s.nextSibling),s)for(c=n.document.createElement("blockquote"),e.place(c,s,"after"),c.appendChild(s),r=c.nextSibling;r&&(this._isTextElement(r)||1===r.nodeType&&this._isInlineFormat(this._getTagName(r)));)c.appendChild(r),r=c.nextSibling}else{for(var u=o.startContainer;(this._isTextElement(u)||this._isInlineFormat(this._getTagName(u))||"li"===this._getTagName(u))&&u!==n.editNode&&u!==n.document.body;)u=u.parentNode;u!==n.editNode&&u!==u.ownerDocument.documentElement&&(c=n.document.createElement("blockquote"),e.place(c,u,"after"),c.appendChild(u))}c&&(n._sCall("selectElementChildren",[c]),n._sCall("collapse",[!0]))}else{var g;for(s=o.startContainer,r=o.endContainer;s&&this._isTextElement(s)&&s.parentNode!==n.editNode;)s=s.parentNode;for(g=s;g.nextSibling&&n._sCall("inSelection",[g]);)g=g.nextSibling;if((r=g)===n.editNode||r===n.document.body){if(c=n.document.createElement("blockquote"),e.place(c,s,"after"),h=this._getTagName(s),this._isTextElement(s)||this._isInlineFormat(h))for(var p=s;p&&(this._isTextElement(p)||1===p.nodeType&&this._isInlineFormat(this._getTagName(p)));)c.appendChild(p),p=c.nextSibling;else c.appendChild(s);return}for(r=r.nextSibling,g=s;g&&g!==r;){if(1===g.nodeType){if("br"!==(h=this._getTagName(g))){if(!window.getSelection&&"p"===h&&this._isEmpty(g)){g=g.nextSibling;continue}this._isInlineFormat(h)?(c?c.appendChild(g):(c=n.document.createElement("blockquote"),e.place(c,g,"after"),c.appendChild(g)),g=c):(c&&this._isEmpty(c)&&c.parentNode.removeChild(c),c=n.document.createElement("blockquote"),e.place(c,g,"after"),c.appendChild(g),g=c)}}else this._isTextElement(g)&&(c?c.appendChild(g):(c=n.document.createElement("blockquote"),e.place(c,g,"after"),c.appendChild(g)),g=c);g=g.nextSibling}c&&(this._isEmpty(c)?c.parentNode.removeChild(c):(n._sCall("selectElementChildren",[c]),n._sCall("collapse",[!0])),c=null)}}else{var m=!1;if(o.startContainer===o.endContainer){for(a=o.endContainer;a&&a!==n.editNode&&a!==n.document.body;){if("blockquote"===(a.tagName?a.tagName.toLowerCase():"")){m=!0;break}a=a.parentNode}if(m){for(var f;a.firstChild;)f=a.firstChild,e.place(f,a,"before");a.parentNode.removeChild(a),f&&(n._sCall("selectElementChildren",[f]),n._sCall("collapse",[!0]))}}else{for(s=o.startContainer,r=o.endContainer;s&&this._isTextElement(s)&&s.parentNode!==n.editNode;)s=s.parentNode;for(var _=[],N=s;N&&N.nextSibling&&n._sCall("inSelection",[N]);)N.parentNode&&"blockquote"===this._getTagName(N.parentNode)&&(N=N.parentNode),_.push(N),N=N.nextSibling;for(var b=this._findBlockQuotes(_);b.length;){var C=b.pop();if(C.parentNode){for(;C.firstChild;)e.place(C.firstChild,C,"before");C.parentNode.removeChild(C)}}}}n.endEditing()}n.onNormalizedDisplayChanged()}catch(e){}},updateState:function(){var e=this.editor,i=this.get("disabled");if(e&&e.isLoaded&&this.button){if(this.button.set("disabled",i),i)return;var n,o=!1,a=t.range.getSelection(e.window);if(a&&a.rangeCount>0){var s=a.getRangeAt(0);s&&(n=s.endContainer)}for(;n&&n!==e.editNode&&n!==e.document;){if("blockquote"===(n.tagName?n.tagName.toLowerCase():"")){o=!0;break}n=n.parentNode}this.button.set("checked",o)}},_findBlockQuotes:function(e){var t=[];if(e){var i;for(i=0;i<e.length;i++){var n=e[i];1===n.nodeType&&("blockquote"===this._getTagName(n)&&t.push(n),n.childNodes&&n.childNodes.length>0&&(t=t.concat(this._findBlockQuotes(n.childNodes))))}}return t},_getTagName:function(e){var t="";return e&&1===e.nodeType&&(t=e.tagName?e.tagName.toLowerCase():""),t},_isRootInline:function(e){var t=this.editor;if(this._isTextElement(e)&&e.parentNode===t.editNode)return!0;if(1===e.nodeType&&this._isInlineFormat(e)&&e.parentNode===t.editNode)return!0;if(this._isTextElement(e)&&this._isInlineFormat(this._getTagName(e.parentNode))){for(e=e.parentNode;e&&e!==t.editNode&&this._isInlineFormat(this._getTagName(e));)e=e.parentNode;if(e===t.editNode)return!0}return!1},_isTextElement:function(e){return!!(e&&3===e.nodeType||4===e.nodeType)},_isEmpty:function(t){if(t.childNodes){var i,n=!0;for(i=0;i<t.childNodes.length;i++){var o=t.childNodes[i];if(1===o.nodeType){if("p"===this._getTagName(o)&&!e.trim(o.innerHTML))continue;n=!1;break}if(!this._isTextElement(o)){n=!1;break}var a=e.trim(o.nodeValue);if(a&&"&nbsp;"!==a&&"Â "!==a){n=!1;break}}return n}return!0},_isInlineFormat:function(e){switch(e){case"a":case"b":case"strong":case"s":case"strike":case"i":case"u":case"em":case"sup":case"sub":case"span":case"font":case"big":case"cite":case"q":case"img":case"small":return!0;default:return!1}}});return e.subscribe(t._scopeName+".Editor.getPlugin",null,function(e){if(!e.plugin){"blockquote"===e.args.name.toLowerCase()&&(e.plugin=new o({}))}}),o});