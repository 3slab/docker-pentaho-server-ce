define(["../_base/lang","../_base/declare","../Deferred","../_base/array","./util/QueryResults","./util/SimpleQueryEngine"],function(t,e,r,i,n,o){return e("dojo.store.DataStore",null,{target:"",constructor:function(e){if(t.mixin(this,e),!1 in e){var r;try{r=this.store.getIdentityAttributes()}catch(t){}this.idProperty=!r||!idAttributes[0]||this.idProperty}var i=this.store.getFeatures();i["dojo.data.api.Read"]||(this.get=null),i["dojo.data.api.Identity"]||(this.getIdentity=null),i["dojo.data.api.Write"]||(this.put=this.add=null)},idProperty:"id",store:null,queryEngine:o,_objectConverter:function(t){function e(t){for(var n={},o=r.getAttributes(t),s=0;s<o.length;s++){var u=o[s],a=r.getValues(t,u);if(a.length>1){for(var d=0;d<a.length;d++){var c=a[d];"object"==typeof c&&r.isItem(c)&&(a[d]=e(c))}c=a}else{var c=r.getValue(t,u);"object"==typeof c&&r.isItem(c)&&(c=e(c))}n[o[s]]=c}return i in n||!r.getIdentity||(n[i]=r.getIdentity(t)),n}var r=this.store,i=this.idProperty;return function(r){return t(e(r))}},get:function(t,e){var i,n,o=new r;if(this.store.fetchItemByIdentity({identity:t,onItem:this._objectConverter(function(t){o.resolve(i=t)}),onError:function(t){o.reject(n=t)}}),i)return i;if(n)throw n;return o.promise},put:function(t,e){var r=e&&void 0!==e.id||this.getIdentity(t),i=this.store,n=this.idProperty;void 0===r?(i.newItem(t),i.save()):i.fetchItemByIdentity({identity:r,onItem:function(e){if(e)for(var r in t)r!=n&&i.getValue(e,r)!=t[r]&&i.setValue(e,r,t[r]);else i.newItem(t);i.save()}})},remove:function(t){var e=this.store;this.store.fetchItemByIdentity({identity:t,onItem:function(t){e.deleteItem(t),e.save()}})},query:function(e,o){var s,u=new r(function(){s.abort&&s.abort()});u.total=new r;var a=this._objectConverter(function(t){return t});return s=this.store.fetch(t.mixin({query:e,onBegin:function(t){u.total.resolve(t)},onComplete:function(t){u.resolve(i.map(t,a))},onError:function(t){u.reject(t)}},o)),n(u)},getIdentity:function(t){return t[this.idProperty]}})});