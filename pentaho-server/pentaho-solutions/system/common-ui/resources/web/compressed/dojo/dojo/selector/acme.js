define(["../dom","../sniff","../_base/array","../_base/lang","../_base/window"],function(n,t,e,r,i){var u=r.trim,o=e.forEach,a=function(){return i.doc},f="BackCompat"==a().compatMode,c=">~+",l=!1,s=function(){return!0},d=function(n){c.indexOf(n.slice(-1))>=0?n+=" * ":n+=" ";for(var t,e,r=function(t,e){return u(n.slice(t,e))},i=[],o=-1,a=-1,f=-1,s=-1,d=-1,g=-1,h=-1,p="",v="",m=0,b=n.length,x=null,y=null,O=function(){if(h>=0){var n=h==m?null:r(h,m);x[c.indexOf(n)<0?"tag":"oper"]=n,h=-1}},A=function(){g>=0&&(x.id=r(g,m).replace(/\\/g,""),g=-1)},_=function(){d>=0&&(x.classes.push(r(d+1,m).replace(/\\/g,"")),d=-1)},N=function(){A(),O(),_()};p=v,v=n.charAt(m),m<b;m++)if("\\"!=p)if(x||(e=m,x={query:null,pseudos:[],attrs:[],classes:[],tag:null,oper:null,id:null,getTag:function(){return l?this.otag:this.tag}},h=m),t)v==t&&(t=null);else if("'"!=v&&'"'!=v)if(o>=0){if("]"==v){y.attr?y.matchFor=r(f||o+1,m):y.attr=r(o+1,m);var T=y.matchFor;T&&('"'!=T.charAt(0)&&"'"!=T.charAt(0)||(y.matchFor=T.slice(1,-1))),y.matchFor&&(y.matchFor=y.matchFor.replace(/\\/g,"")),x.attrs.push(y),y=null,o=f=-1}else if("="==v){var w="|~^$*".indexOf(p)>=0?p:"";y.type=w+v,y.attr=r(o+1,m-w.length),f=m+1}}else a>=0?")"==v&&(s>=0&&(y.value=r(a+1,m)),s=a=-1):"#"==v?(N(),g=m+1):"."==v?(N(),d=m):":"==v?(N(),s=m):"["==v?(N(),o=m,y={}):"("==v?(s>=0&&(y={name:r(s+1,m),value:null},x.pseudos.push(y)),a=m):" "==v&&p!=v&&function(){N(),s>=0&&x.pseudos.push({name:r(s+1,m)}),x.loops=x.pseudos.length||x.attrs.length||x.classes.length,x.oquery=x.query=r(e,m),x.otag=x.tag=x.oper?null:x.tag||"*",x.tag&&(x.tag=x.tag.toUpperCase()),i.length&&i[i.length-1].oper&&(x.infixOper=i.pop(),x.query=x.infixOper.query+" "+x.query),i.push(x),x=null}();else t=v;return i},g=function(n,t){return n?t?function(){return n.apply(window,arguments)&&t.apply(window,arguments)}:n:t},h=function(n,t){var e=t||[];return n&&e.push(n),e},p=function(n){return 1==n.nodeType},v=function(n,t){return n?"class"==t?n.className||"":"for"==t?n.htmlFor||"":"style"==t?n.style.cssText||"":(l?n.getAttribute(t):n.getAttribute(t,2))||"":""},m={"*=":function(n,t){return function(e){return v(e,n).indexOf(t)>=0}},"^=":function(n,t){return function(e){return 0==v(e,n).indexOf(t)}},"$=":function(n,t){return function(e){var r=" "+v(e,n),i=r.lastIndexOf(t);return i>-1&&i==r.length-t.length}},"~=":function(n,t){var e=" "+t+" ";return function(t){return(" "+v(t,n)+" ").indexOf(e)>=0}},"|=":function(n,t){var e=t+"-";return function(r){var i=v(r,n);return i==t||0==i.indexOf(e)}},"=":function(n,t){return function(e){return v(e,n)==t}}},b=void 0===a().firstChild.nextElementSibling,x=b?"nextSibling":"nextElementSibling",y=b?"previousSibling":"previousElementSibling",O=b?p:s,A=function(n){for(;n=n[y];)if(O(n))return!1;return!0},_=function(n){for(;n=n[x];)if(O(n))return!1;return!0},N=function(n){var e=n.parentNode;e=7!=e.nodeType?e:e.nextSibling;var r=0,i=e.children||e.childNodes,u=n._i||n.getAttribute("_i")||-1,o=e._l||(void 0!==e.getAttribute?e.getAttribute("_l"):-1);if(!i)return-1;var a=i.length;if(o==a&&u>=0&&o>=0)return u;t("ie")&&void 0!==e.setAttribute?e.setAttribute("_l",a):e._l=a,u=-1;for(var f=e.firstElementChild||e.firstChild;f;f=f[x])O(f)&&(t("ie")?f.setAttribute("_i",++r):f._i=++r,n===f&&(u=r));return u},T=function(n){return!(N(n)%2)},w=function(n){return N(n)%2},q={checked:function(n,t){return function(n){return!!("checked"in n?n.checked:n.selected)}},disabled:function(n,t){return function(n){return n.disabled}},enabled:function(n,t){return function(n){return!n.disabled}},"first-child":function(){return A},"last-child":function(){return _},"only-child":function(n,t){return function(n){return A(n)&&_(n)}},empty:function(n,t){return function(n){for(var t=n.childNodes,e=n.childNodes.length,r=e-1;r>=0;r--){var i=t[r].nodeType;if(1===i||3==i)return!1}return!0}},contains:function(n,t){var e=t.charAt(0);return'"'!=e&&"'"!=e||(t=t.slice(1,-1)),function(n){return n.innerHTML.indexOf(t)>=0}},not:function(n,t){var e=d(t)[0],r={el:1};"*"!=e.tag&&(r.tag=1),e.classes.length||(r.classes=1);var i=S(e,r);return function(n){return!i(n)}},"nth-child":function(n,t){var e=parseInt;if("odd"==t)return w;if("even"==t)return T;if(-1!=t.indexOf("n")){var r=t.split("n",2),i=r[0]?"-"==r[0]?-1:e(r[0]):1,u=r[1]?e(r[1]):0,o=0,a=-1;if(i>0?u<0?u=u%i&&i+u%i:u>0&&(u>=i&&(o=u-u%i),u%=i):i<0&&(i*=-1,u>0&&(a=u,u%=i)),i>0)return function(n){var t=N(n);return t>=o&&(a<0||t<=a)&&t%i==u};t=u}var f=e(t);return function(n){return N(n)==f}}},E=t("ie")<9||9==t("ie")&&t("quirks")?function(n){var t=n.toLowerCase();return"class"==t&&(n="className"),function(e){return l?e.getAttribute(n):e[n]||e[t]}}:function(n){return function(t){return t&&t.getAttribute&&t.hasAttribute(n)}},S=function(n,t){if(!n)return s;t=t||{};var e=null;return"el"in t||(e=g(e,p)),"tag"in t||"*"!=n.tag&&(e=g(e,function(t){return t&&(l?t.tagName:t.tagName.toUpperCase())==n.getTag()})),"classes"in t||o(n.classes,function(n,t,r){var i=new RegExp("(?:^|\\s)"+n+"(?:\\s|$)");e=g(e,function(n){return i.test(n.className)}),e.count=t}),"pseudos"in t||o(n.pseudos,function(n){var t=n.name;q[t]&&(e=g(e,q[t](t,n.value)))}),"attrs"in t||o(n.attrs,function(n){var t,r=n.attr;n.type&&m[n.type]?t=m[n.type](r,n.matchFor):r.length&&(t=E(r)),t&&(e=g(e,t))}),"id"in t||n.id&&(e=g(e,function(t){return!!t&&t.id==n.id})),e||"default"in t||(e=s),e},k=function(n){return function(t,e,r){for(;t=t[x];)if(!b||p(t)){r&&!W(t,r)||!n(t)||e.push(t);break}return e}},z=function(n){return function(t,e,r){for(var i=t[x];i;){if(O(i)){if(r&&!W(i,r))break;n(i)&&e.push(i)}i=i[x]}return e}},C=function(n){return n=n||s,function(t,e,r){for(var i,u=0,o=t.children||t.childNodes;i=o[u++];)O(i)&&(!r||W(i,r))&&n(i,u)&&e.push(i);return e}},I=function(n,t){for(var e=n.parentNode;e&&e!=t;)e=e.parentNode;return!!e},F={},B=function(t){var e=F[t.query];if(e)return e;var r=t.infixOper,i=r?r.oper:"",u=S(t,{el:1}),o=t.tag,c="*"==o,l=a().getElementsByClassName;if(i){var d={el:1};c&&(d.tag=1),u=S(t,d),"+"==i?e=k(u):"~"==i?e=z(u):">"==i&&(e=C(u))}else if(t.id)u=!t.loops&&c?s:S(t,{el:1,id:1}),e=function(e,r){var i=n.byId(t.id,e.ownerDocument||e);if(i&&u(i))return 9==e.nodeType?h(i,r):I(i,e)?h(i,r):void 0};else if(l&&/\{\s*\[native code\]\s*\}/.test(String(l))&&t.classes.length&&!f){u=S(t,{el:1,classes:1,id:1});var g=t.classes.join(" ");e=function(n,t,e){for(var r,i=h(0,t),o=0,a=n.getElementsByClassName(g);r=a[o++];)u(r,n)&&W(r,e)&&i.push(r);return i}}else c||t.loops?(u=S(t,{el:1,tag:1,id:1}),e=function(n,e,r){for(var i,o=h(0,e),a=0,f=t.getTag(),c=f?n.getElementsByTagName(f):[];i=c[a++];)u(i,n)&&W(i,r)&&o.push(i);return o}):e=function(n,e,r){for(var i,u=h(0,e),o=0,a=t.getTag(),f=a?n.getElementsByTagName(a):[];i=f[o++];)W(i,r)&&u.push(i);return u};return F[t.query]=e},D=function(n,t){for(var e,r,i,u,o,a=h(n),f=t.length,c=0;c<f;c++){o=[],e=t[c],r=a.length-1,r>0&&(u={},o.nozip=!0);for(var l=B(e),s=0;i=a[s];s++)l(i,o,u);if(!o.length)break;a=o}return o},$={},L={},M=function(n){var t=d(u(n));if(1==t.length){var e=B(t[0]);return function(n){var t=e(n,[]);return t&&(t.nozip=!0),t}}return function(n){return D(n,t)}},U=t("ie")?"commentStrip":"nozip",j="querySelectorAll",H=!!a()[j],R=/\\[>~+]|n\+\d|([^ \\])?([>~+])([^ =])?/g,G=function(n,t,e,r){return e?(t?t+" ":"")+e+(r?" "+r:""):n},J=/([^[]*)([^\]]*])?/g,K=function(n,t,e){return t.replace(R,G)+(e||"")},P=function(n,e){if(n=n.replace(J,K),H){var r=L[n];if(r&&!e)return r}var i=$[n];if(i)return i;var u=n.charAt(0),o=-1==n.indexOf(" ");if(n.indexOf("#")>=0&&o&&(e=!0),H&&!e&&-1==c.indexOf(u)&&(!t("ie")||-1==n.indexOf(":"))&&!(f&&n.indexOf(".")>=0)&&-1==n.indexOf(":contains")&&-1==n.indexOf(":checked")&&-1==n.indexOf("|=")){var a=c.indexOf(n.charAt(n.length-1))>=0?n+" *":n;return L[n]=function(t){try{if(9!=t.nodeType&&!o)throw"";var e=t[j](a);return e[U]=!0,e}catch(e){return P(n,!0)(t)}}}var l=n.match(/([^\s,](?:"(?:\\.|[^"])+"|'(?:\\.|[^'])+'|[^,])*)/g);return $[n]=l.length<2?M(n):function(n){for(var t,e=0,r=[];t=l[e++];)r=r.concat(M(t)(n));return r}},Q=0,V=t("ie")?function(n){return l?n.getAttribute("_uid")||n.setAttribute("_uid",++Q)||Q:n.uniqueID}:function(n){return n._uid||(n._uid=++Q)},W=function(n,t){if(!t)return 1;var e=V(n);return t[e]?0:t[e]=1},X=function(n){if(n&&n.nozip)return n;if(!n||!n.length)return[];if(n.length<2)return[n[0]];var e=[];Q++;var r,i;if(t("ie")&&l){var u=Q+"";for(r=0;r<n.length;r++)(i=n[r])&&i.getAttribute("_zipIdx")!=u&&(e.push(i),i.setAttribute("_zipIdx",u))}else if(t("ie")&&n.commentStrip)try{for(r=0;r<n.length;r++)(i=n[r])&&p(i)&&e.push(i)}catch(n){}else for(r=0;r<n.length;r++)(i=n[r])&&i._zipIdx!=Q&&(e.push(i),i._zipIdx=Q);return e},Y=function(n,t){t=t||a();var e=t.ownerDocument||t;l="div"===e.createElement("div").tagName;var r=P(n)(t);return r&&r.nozip?r:X(r)};return Y.filter=function(t,r,i){for(var u,o=[],a=d(r),f=1!=a.length||/[^\w#\.]/.test(r)?function(t){return-1!=e.indexOf(Y(r,n.byId(i)),t)}:S(a[0]),c=0;u=t[c];c++)f(u)&&o.push(u);return o},Y});