dojo.provide("dojox.xmpp.sasl"),dojo.require("dojox.xmpp.util"),dojo.require("dojo.AdapterRegistry"),dojo.require("dojox.encoding.digests.MD5"),dojox.xmpp.sasl.saslNS="urn:ietf:params:xml:ns:xmpp-sasl",dojo.declare("dojox.xmpp.sasl._Base",null,{mechanism:null,closeAuthTag:!0,constructor:function(s){this.session=s,this.startAuth()},startAuth:function(){var s=new dojox.string.Builder(dojox.xmpp.util.createElement("auth",{xmlns:dojox.xmpp.sasl.saslNS,mechanism:this.mechanism},this.closeAuthTag));this.appendToAuth(s),this.session.dispatchPacket(s.toString())},appendToAuth:function(s){},onChallenge:function(s){this.first_challenge?this.onSecondChallenge(s):(this.first_challenge=!0,this.onFirstChallenge(s))},onFirstChallenge:function(){},onSecondChallenge:function(){},onSuccess:function(){this.session.sendRestart()}}),dojo.declare("dojox.xmpp.sasl.SunWebClientAuth",dojox.xmpp.sasl._Base,{mechanism:"SUN-COMMS-CLIENT-PROXY-AUTH"}),dojo.declare("dojox.xmpp.sasl.Plain",dojox.xmpp.sasl._Base,{mechanism:"PLAIN",closeAuthTag:!1,appendToAuth:function(s){var e=this.session.jid,o=this.session.jid.indexOf("@");-1!=o&&(e=this.session.jid.substring(0,o));var n=this.session.jid+"\0"+e+"\0"+this.session.password;n=dojox.xmpp.util.Base64.encode(n),s.append(n),s.append("</auth>"),delete this.session.password}}),dojo.declare("dojox.xmpp.sasl.DigestMD5",dojox.xmpp.sasl._Base,{mechanism:"DIGEST-MD5",onFirstChallenge:function(s){var e=dojox.encoding.digests,o=dojox.encoding.digests.outputTypes,n=function(s){return e.MD5(s,o.Hex)},t=dojox.xmpp.util.Base64.decode(s.firstChild.nodeValue),i={realm:"",nonce:"",qop:"auth",maxbuf:65536};t.replace(/([a-z]+)=([^,]+)/g,function(s,e,o){o=o.replace(/^"(.+)"$/,"$1"),i[e]=o});var a="";switch(i.qop){case"auth-int":case"auth-conf":a=":00000000000000000000000000000000";case"auth":break;default:return!1}var r=e.MD5(1234567890*Math.random(),o.Hex),d="xmpp/"+this.session.domain,p=this.session.jid,l=this.session.jid.indexOf("@");-1!=l&&(p=this.session.jid.substring(0,l)),p=dojox.xmpp.util.encodeJid(p);var u=new dojox.string.Builder;u.append(function(s){return e.MD5(s,o.String)}(p+":"+i.realm+":"+this.session.password),":",i.nonce+":"+r),delete this.session.password;var x=":"+d+a,c="AUTHENTICATE"+x,h=new dojox.string.Builder;h.append(n(u.toString()),":",i.nonce,":00000001:",r,":",i.qop,":");var m=new dojox.string.Builder;m.append('username="',p,'",','realm="',i.realm,'",',"nonce=",i.nonce,",",'cnonce="',r,'",','nc="00000001",qop="',i.qop,'",digest-uri="',d,'",','response="',n(h.toString()+n(c)),'",charset="utf-8"');var j=new dojox.string.Builder(dojox.xmpp.util.createElement("response",{xmlns:dojox.xmpp.xmpp.SASL_NS},!1));j.append(dojox.xmpp.util.Base64.encode(m.toString())),j.append("</response>"),this.rspauth=n(h.toString()+n(x)),this.session.dispatchPacket(j.toString())},onSecondChallenge:function(s){var e=dojox.xmpp.util.Base64.decode(s.firstChild.nodeValue);if(this.rspauth==e.substring(8)){var o=new dojox.string.Builder(dojox.xmpp.util.createElement("response",{xmlns:dojox.xmpp.xmpp.SASL_NS},!0));this.session.dispatchPacket(o.toString())}}}),dojox.xmpp.sasl.registry=new dojo.AdapterRegistry,dojox.xmpp.sasl.registry.register("SUN-COMMS-CLIENT-PROXY-AUTH",function(s){return"SUN-COMMS-CLIENT-PROXY-AUTH"==s},function(s,e){return new dojox.xmpp.sasl.SunWebClientAuth(e)}),dojox.xmpp.sasl.registry.register("DIGEST-MD5",function(s){return"DIGEST-MD5"==s},function(s,e){return new dojox.xmpp.sasl.DigestMD5(e)}),dojox.xmpp.sasl.registry.register("PLAIN",function(s){return"PLAIN"==s},function(s,e){return new dojox.xmpp.sasl.Plain(e)});