dojo.provide("dojox.robot.recorder"),dojo.experimental("dojox.robot.recorder"),function(){var KEYPRESS_MAXIMUM_DELAY=1e3,MOUSEMOVE_MAXIMUM_DELAY=500,MAXIMUM_DELAY=1e4,commands=[],testNumber=0,startTime=null,prevTime=null,start=function(){alert("Started recording."),commands=[],startTime=new Date,prevTime=new Date},addCommand=function(name,args){if(!(null==startTime||"doh.robot.keyPress"==name&&args[0]==dojo.keys.ENTER&&eval("("+args[2]+")").ctrl&&eval("("+args[2]+")").alt)){var dt=Math.max(Math.min(Math.round((new Date).getTime()-prevTime.getTime()),MAXIMUM_DELAY),1);"doh.robot.mouseMove"==name?args[2]=dt:args[1]=dt,commands.push({name:name,args:args}),prevTime=new Date}},_optimize=function(){var c=commands;"doh.robot.keyPress"!=c[0].name||c[0].args[0]!=dojo.keys.ENTER&&77!=c[0].args[0]||c.splice(0,1);for(var i=c.length-1;i>=c.length-2&&i>=0;i--)("doh.robot.keyPress"==c[i].name&&c[i].args[0]==dojo.keys.ALT||c[i].args[0]==dojo.keys.CTRL)&&c.splice(i,1);for(i=0;i<c.length;i++){var next,nextdt;if(c[i+1]&&"doh.robot.mouseMove"==c[i].name&&c[i+1].name==c[i].name&&c[i+1].args[2]<MOUSEMOVE_MAXIMUM_DELAY){for(next=c[i+1],nextdt=0;next&&next.name==c[i].name&&next.args[2]<MOUSEMOVE_MAXIMUM_DELAY;)c.splice(i+1,1),nextdt+=next.args[2],c[i].args[0]=next.args[0],c[i].args[1]=next.args[1],next=c[i+1];c[i].args[3]=nextdt}else if(c[i+1]&&"doh.robot.mouseWheel"==c[i].name&&c[i+1].name==c[i].name&&c[i+1].args[1]<MOUSEMOVE_MAXIMUM_DELAY){for(next=c[i+1],nextdt=0;next&&next.name==c[i].name&&next.args[1]<MOUSEMOVE_MAXIMUM_DELAY;)c.splice(i+1,1),nextdt+=next.args[1],c[i].args[0]+=next.args[0],next=c[i+1];c[i].args[2]=nextdt}else if(c[i+2]&&"doh.robot.mouseMoveAt"==c[i].name&&"doh.robot.scrollIntoView"==c[i+2].name){var temp=c.splice(i+2,1)[0];c.splice(i,0,temp)}else if(c[i+1]&&"doh.robot.mousePress"==c[i].name&&"doh.robot.mouseRelease"==c[i+1].name&&c[i].args[0]==c[i+1].args[0])c[i].name="doh.robot.mouseClick",c.splice(i+1,1),c[i+1]&&"doh.robot.mouseClick"==c[i+1].name&&c[i].args[0]==c[i+1].args[0]&&c.splice(i+1,1);else if(c[i+1]&&c[i-1]&&"doh.robot.mouseMoveAt"==c[i-1].name&&"doh.robot.mousePress"==c[i].name&&"doh.robot.mouseMove"==c[i+1].name){var cmd={name:"doh.robot.mouseMoveAt",args:[c[i-1].args[0],1,100,c[i-1].args[3]+1,c[i-1].args[4]]};c.splice(i+1,0,cmd)}else if(!(c[i+1]&&("doh.robot.keyPress"==c[i].name&&"string"==typeof c[i].args[0]||"doh.robot.typeKeys"==c[i].name)&&"doh.robot.keyPress"==c[i+1].name&&"string"==typeof c[i+1].args[0]&&c[i+1].args[1]<=KEYPRESS_MAXIMUM_DELAY)||eval("("+c[i].args[2]+")").ctrl||eval("("+c[i].args[2]+")").alt||eval("("+c[i+1].args[2]+")").ctrl||eval("("+c[i+1].args[2]+")").alt){if("doh.robot.keyPress"==c[i].name)if("string"==typeof c[i].args[0])c[i].args[0]="'"+c[i].args[0]+"'";else if(0==c[i].args[0])c.splice(i,1);else for(var j in dojo.keys)if(dojo.keys[j]==c[i].args[0]){c[i].args[0]="dojo.keys."+j;break}}else{c[i].name="doh.robot.typeKeys",c[i].args.splice(3,1),next=c[i+1];for(var typeTime=0;next&&"doh.robot.keyPress"==next.name&&"string"==typeof next.args[0]&&next.args[1]<=KEYPRESS_MAXIMUM_DELAY&&!eval("("+next.args[2]+")").ctrl&&!eval("("+next.args[2]+")").alt;)c.splice(i+1,1),c[i].args[0]+=next.args[0],typeTime+=next.args[1],next=c[i+1];c[i].args[2]=typeTime,c[i].args[0]="'"+c[i].args[0]+"'"}}},toggle=function(){startTime?stop():start()},stop=function(){var e=Math.round((new Date).getTime()-startTime.getTime());startTime=null,_optimize();var o=commands;if(console.log("Stop called. Commands: "+o.length),o.length){var t="doh.register('dojox.robot.AutoGeneratedTestGroup',{\n";t+="     name: 'autotest"+testNumber+++"',\n",t+="     timeout: "+(e+2e3)+",\n",t+="     runTest: function(){\n",t+="          var d = new doh.Deferred();\n";for(var n=0;n<o.length;n++){t+="          "+o[n].name+"(";for(var a=0;a<o[n].args.length;a++){t+=o[n].args[a],a!=o[n].args.length-1&&(t+=", ")}t+=");\n"}t+="          doh.robot.sequence(function(){\n",t+="               if(/*Your condition here*/){\n",t+="                    d.callback(true);\n",t+="               }else{\n",t+="                    d.errback(new Error('We got a failure'));\n",t+="               }\n",t+="          }, 1000);\n",t+="          return d;\n",t+="     }\n",t+="});\n";var r=document.createElement("div");r.id="dojox.robot.recorder",r.style.backgroundColor="white",r.style.position="absolute";var s={y:window.pageYOffset||document.documentElement.scrollTop||document.body.scrollTop||0,x:window.pageXOffset||(window.dojo?dojo._fixIeBiDiScrollLeft(document.documentElement.scrollLeft):void 0)||document.body.scrollLeft||0};r.style.left=s.x+"px",r.style.top=s.y+"px";var c=document.createElement("h1");c.innerHTML="Your code:",r.appendChild(c);var i=document.createElement("pre");void 0!==i.innerText?i.innerText=t:i.textContent=t,r.appendChild(i);var d=document.createElement("button");d.innerHTML="Close";var l=dojo.connect(d,"onmouseup",function(e){dojo.stopEvent(e),document.body.removeChild(r),dojo.disconnect(l)});r.appendChild(d),document.body.appendChild(r),commands=[]}},getSelector=function(e){if("string"==typeof e)return"'"+e+"'";if(e.id)return"'"+e.id+"'";var o,t=document.getElementsByTagName(e.nodeName);for(o=0;o<t.length&&t[o]!=e;o++);return"function(){ return document.getElementsByTagName('"+e.nodeName+"')["+o+"]; }"},getMouseButtonObject=function(e){return"{left:"+(0==e)+", middle:"+(1==e)+", right:"+(2==e)+"}"},getModifierObject=function(e){return"{'shift':"+e.shiftKey+", 'ctrl':"+e.ctrlKey+", 'alt':"+e.altKey+"}"};dojo.connect(document,"onkeydown",function(e){(e.keyCode==dojo.keys.ENTER||77==e.keyCode)&&e.ctrlKey&&e.altKey&&(dojo.stopEvent(e),toggle())});var lastEvent={type:""},onmousedown=function(e){if(e&&(lastEvent.type!=e.type||lastEvent.button!=e.button)){lastEvent={type:e.type,button:e.button};var o=getSelector(e.target),t=dojo.coords(e.target);addCommand("doh.robot.mouseMoveAt",[o,0,100,e.clientX-t.x,e.clientY-t.y]),addCommand("doh.robot.mousePress",[getMouseButtonObject(e.button-(dojo.isIE?1:0)),0])}},onclick=function(e){if(e&&(lastEvent.type!=e.type||lastEvent.button!=e.button)){lastEvent={type:e.type,button:e.button};getSelector(e.target),dojo.coords(e.target);addCommand("doh.robot.mouseClick",[getMouseButtonObject(e.button-(dojo.isIE?1:0)),0])}},onmouseup=function(e){if(e&&(lastEvent.type!=e.type||lastEvent.button!=e.button)){lastEvent={type:e.type,button:e.button};getSelector(e.target),dojo.coords(e.target);addCommand("doh.robot.mouseRelease",[getMouseButtonObject(e.button-(dojo.isIE?1:0)),0])}},onmousemove=function(e){!e||lastEvent.type==e.type&&lastEvent.pageX==e.pageX&&lastEvent.pageY==e.pageY||(lastEvent={type:e.type,pageX:e.pageX,pageY:e.pageY},addCommand("doh.robot.mouseMove",[e.pageX,e.pageY,0,100,!0]))},onmousewheel=function(e){!e||lastEvent.type==e.type&&lastEvent.pageX==e.pageX&&lastEvent.pageY==e.pageY||(lastEvent={type:e.type,detail:e.detail?e.detail:-e.wheelDelta/120},addCommand("doh.robot.mouseWheel",[lastEvent.detail]))},onkeypress=function(e){!e||lastEvent.type==e.type&&lastEvent.charCode==e.charCode&&lastEvent.keyCode==e.keyCode||(lastEvent={type:e.type,charCode:e.charCode,keyCode:e.keyCode},addCommand("doh.robot.keyPress",[e.charOrCode==dojo.keys.SPACE?" ":e.charOrCode,0,getModifierObject(e)]))},onkeyup=function(e){!e||lastEvent.type==e.type&&lastEvent.charCode==e.charCode&&lastEvent.keyCode==e.keyCode||(lastEvent={type:e.type,charCode:e.charCode,keyCode:e.keyCode})};dojo.connect(document,"onmousedown",onmousedown),dojo.connect(document,"onmouseup",onmouseup),dojo.connect(document,"onclick",onclick),dojo.connect(document,"onkeypress",onkeypress),dojo.connect(document,"onkeyup",onkeyup),dojo.connect(document,"onmousemove",onmousemove),dojo.connect(document,dojo.isMozilla?"DOMMouseScroll":"onmousewheel",onmousewheel),dojo.addOnLoad(function(){dojo.window&&dojo.connect(dojo.window,"scrollIntoView",function(e){addCommand("doh.robot.scrollIntoView",[getSelector(e)])})}),dojo.connect(dojo,"connect",function(e,o,t){if(e&&(!t||!t._mine)){var n=null;if("onmousedown"==o.toLowerCase()?n=dojo.hitch(this,onmousedown):o.toLowerCase()==(dojo.isMozilla?"dommousescroll":"onmousewheel")?n=dojo.hitch(this,onmousewheel):"onclick"==o.toLowerCase()?n=dojo.hitch(this,onclick):"onmouseup"==o.toLowerCase()?n=dojo.hitch(this,onmouseup):"onkeypress"==o.toLowerCase()?n=dojo.hitch(this,onkeypress):"onkeyup"==o.toLowerCase()&&(n=dojo.hitch(this,onkeyup)),null==n)return;n._mine=!0,dojo.connect(e,o,n)}})}();