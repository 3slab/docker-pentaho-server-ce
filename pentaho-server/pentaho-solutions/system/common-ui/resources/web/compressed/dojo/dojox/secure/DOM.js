dojo.provide("dojox.secure.DOM"),dojo.require("dojox.lang.observable"),dojox.secure.DOM=function(e){function n(n){if(!n)return n;var r=n;do{if(r==e)return t(n)}while(r=r.parentNode);return null}function t(e){if(e){if(e.nodeType){var n=h(e);return 1==e.nodeType&&"function"==typeof n.style&&(n.style=v(e.style),n.ownerDocument=d,n.childNodes={__get__:function(n){return t(e.childNodes[n])},length:0}),n}if(e&&"object"==typeof e){if(e.__observable)return e.__observable;n=e instanceof Array?[]:{},e.__observable=n;for(var r in e)"__observable"!=r&&(n[r]=t(e[r]));return n.data__=e,n}if("function"==typeof e){var o=function(e){return"function"==typeof e?function(){for(var n=0;n<arguments.length;n++)arguments[n]=t(arguments[n]);return o(e.apply(t(this),arguments))}:dojox.secure.unwrap(e)};return function(){e.safetyCheck&&e.safetyCheck.apply(o(this),arguments);for(var n=0;n<arguments.length;n++)arguments[n]=o(arguments[n]);return t(e.apply(o(this),arguments))}}}return e}function r(n){if(n+="",n.match(/behavior:|content:|javascript:|binding|expression|\@import/))throw new Error("Illegal CSS");var t=e.id||(e.id="safe"+(""+Math.random()).substring(2));return n.replace(/(\}|^)\s*([^\{]*\{)/g,function(e,n,r){return n+" #"+t+" "+r})}function o(e){if(e.match(/:/)&&!e.match(/^(http|ftp|mailto)/))throw new Error("Unsafe URL "+e)}function i(e){if(e&&1==e.nodeType){if(e.tagName.match(/script/i)){var n=e.src;if(n&&""!=n)e.parentNode.removeChild(e),dojo.xhrGet({url:n,secure:!0}).addCallback(function(e){d.evaluate(e)});else{var a=e.innerHTML;e.parentNode.removeChild(e),t.evaluate(a)}}if(e.tagName.match(/link/i))throw new Error("illegal tag");if(e.tagName.match(/style/i)){var c=function(n){if(e.styleSheet)e.styleSheet.cssText=n;else{var t=u.createTextNode(n);e.childNodes[0]?e.replaceChild(t,e.childNodes[0]):e.appendChild(t)}};n=e.src,n&&""!=n&&(alert("src"+n),e.src=null,dojo.xhrGet({url:n,secure:!0}).addCallback(function(e){c(r(e))})),c(r(e.innerHTML))}e.style&&r(e.style.cssText),e.href&&o(e.href),e.src&&o(e.src);for(var l,f=0;l=e.attributes[f++];)if("on"==l.name.substring(0,2)&&"null"!=l.value&&""!=l.value)throw new Error("event handlers not allowed in the HTML, they must be set with element.addEventListener");for(var s=e.childNodes,f=0,h=s.length;f<h;f++)i(s[f])}}function a(e){var n=document.createElement("div");if(e.match(/<object/i))throw new Error("The object tag is not allowed");return n.innerHTML=e,i(n),n}function c(e,n){return function(t,r){return i(r[n]),t[e](r[0])}}function l(e){return dojox.lang.makeObservable(function(e,n){return e[n]},e,function(e,n,r,o){for(var i=0;i<o.length;i++)o[i]=unwrap(o[i]);return t(s[r]?s[r].call(e,n,o):n[r].apply(n,o))},s)}unwrap=dojox.secure.unwrap;var u=e.ownerDocument,d={getElementById:function(e){return n(u.getElementById(e))},createElement:function(e){return t(u.createElement(e))},createTextNode:function(e){return t(u.createTextNode(e))},write:function(n){for(var t=a(n);t.childNodes.length;)e.appendChild(t.childNodes[0])}};d.open=d.close=function(){};var f={innerHTML:function(e,n){console.log("setting innerHTML"),e.innerHTML=a(n).innerHTML}};f.outerHTML=function(e,n){throw new Error("Can not set this property")};var s={appendChild:c("appendChild",0),insertBefore:c("insertBefore",0),replaceChild:c("replaceChild",1),cloneNode:function(e,n){return e.cloneNode(n[0])},addEventListener:function(e,n){dojo.connect(e,"on"+n[0],this,function(e){e=h(e||window.event),n[1].call(this,e)})}};s.childNodes=s.style=s.ownerDocument=function(){};var h=l(function(e,n,t){f[n]&&f[n](e,t),e[n]=t}),p={behavior:1,MozBinding:1},v=l(function(e,n,t){p[n]||(e[n]=r(t))});return t.safeHTML=a,t.safeCSS=r,t},dojox.secure.unwrap=function(e){return e&&e.data__||e};