define(["./kernel","./sniff","require","../io-query","../dom","../dom-form","./Deferred","./config","./json","./lang","./array","../on","../aspect","../request/watch","../request/xhr","../request/util"],function(e,r,o,t,n,i,s,u,a,c,l,d,h,f,p,y){e._xhrObj=p._create;var x=e.config;e.objectToQuery=t.objectToQuery,e.queryToObject=t.queryToObject,e.fieldToObject=i.fieldToObject,e.formToObject=i.toObject,e.formToQuery=i.toQuery,e.formToJson=i.toJson,e._blockAsync=!1;var m=e._contentHandlers=e.contentHandlers={text:function(e){return e.responseText},json:function(e){return a.fromJson(e.responseText||null)},"json-comment-filtered":function(e){u.useCommentedJson||console.warn("Consider using the standard mimetype:application/json. json-commenting can introduce security issues. To decrease the chances of hijacking, use the standard the 'json' handler and prefix your json with: {}&&\nUse djConfig.useCommentedJson=true to turn off this message.");var r=e.responseText,o=r.indexOf("/*"),t=r.lastIndexOf("*/");if(-1==o||-1==t)throw new Error("JSON was not comment filtered");return a.fromJson(r.substring(o+2,t))},javascript:function(r){return e.eval(r.responseText)},xml:function(e){var o=e.responseXML;if(o&&r("dom-qsa2.1")&&!o.querySelectorAll&&r("dom-parser")&&(o=(new DOMParser).parseFromString(e.responseText,"application/xml")),r("ie")&&(!o||!o.documentElement)){var t=function(e){return"MSXML"+e+".DOMDocument"},n=["Microsoft.XMLDOM",t(6),t(4),t(3),t(2)];l.some(n,function(r){try{var t=new ActiveXObject(r);t.async=!1,t.loadXML(e.responseText),o=t}catch(e){return!1}return!0})}return o},"json-comment-optional":function(e){return e.responseText&&/^[^{\[]*\/\*/.test(e.responseText)?m["json-comment-filtered"](e):m.json(e)}};e._ioSetArgs=function(r,o,u,a){var l={args:r,url:r.url},d=null;if(r.form){var h=n.byId(r.form),f=h.getAttributeNode("action");l.url=l.url||(f?f.value:null),d=i.toObject(h)}var p=[{}];d&&p.push(d),r.content&&p.push(r.content),r.preventCache&&p.push({"dojo.preventCache":(new Date).valueOf()}),l.query=t.objectToQuery(c.mixin.apply(null,p)),l.handleAs=r.handleAs||"text";var y=new s(function(e){e.canceled=!0,o&&o(e);var r=e.ioArgs.error;return r||(r=new Error("request cancelled"),r.dojoType="cancel",e.ioArgs.error=r),r});y.addCallback(u);var m=r.load;m&&c.isFunction(m)&&y.addCallback(function(e){return m.call(r,e,l)});var b=r.error;b&&c.isFunction(b)&&y.addErrback(function(e){return b.call(r,e,l)});var T=r.handle;return T&&c.isFunction(T)&&y.addBoth(function(e){return T.call(r,e,l)}),y.addErrback(function(e){return a(e,y)}),x.ioPublish&&e.publish&&!1!==l.args.ioPublish&&(y.addCallbacks(function(r){return e.publish("/dojo/io/load",[y,r]),r},function(r){return e.publish("/dojo/io/error",[y,r]),r}),y.addBoth(function(r){return e.publish("/dojo/io/done",[y,r]),r})),y.ioArgs=l,y};var b=function(e){var r=m[e.ioArgs.handleAs](e.ioArgs.xhr);return void 0===r?null:r},T=function(e,r){return r.ioArgs.args.failOk||console.error(e),e},j=function(r){g<=0&&(g=0,x.ioPublish&&e.publish&&(!r||r&&!1!==r.ioArgs.args.ioPublish)&&e.publish("/dojo/io/stop"))},g=0;h.after(f,"_onAction",function(){g-=1}),h.after(f,"_onInFlight",j),e._ioCancelAll=f.cancelAll,e._ioNotifyStart=function(r){x.ioPublish&&e.publish&&!1!==r.ioArgs.args.ioPublish&&(g||e.publish("/dojo/io/start"),g+=1,e.publish("/dojo/io/send",[r]))},e._ioWatch=function(e,r,o,t){e.ioArgs.options=e.ioArgs.args;c.mixin(e,{response:e.ioArgs,isValid:function(o){return r(e)},isReady:function(r){return o(e)},handleResponse:function(r){return t(e)}}),f(e),j(e)};return e._ioAddQueryToUrl=function(e){e.query.length&&(e.url+=(-1==e.url.indexOf("?")?"?":"&")+e.query,e.query=null)},e.xhr=function(r,o,t){var n,i=e._ioSetArgs(o,function(e){n&&n.cancel()},b,T),s=i.ioArgs;"postData"in o?s.query=o.postData:"putData"in o?s.query=o.putData:"rawBody"in o?s.query=o.rawBody:(arguments.length>2&&!t||-1==="POST|PUT".indexOf(r.toUpperCase()))&&e._ioAddQueryToUrl(s);var u={method:r,handleAs:"text",timeout:o.timeout,withCredentials:o.withCredentials,ioArgs:s};void 0!==o.headers&&(u.headers=o.headers),void 0!==o.contentType&&(u.headers||(u.headers={}),u.headers["Content-Type"]=o.contentType),void 0!==s.query&&(u.data=s.query),void 0!==o.sync&&(u.sync=o.sync),e._ioNotifyStart(i);try{n=p(s.url,u,!0)}catch(e){return i.cancel(),i}return i.ioArgs.xhr=n.response.xhr,n.then(function(){i.resolve(i)}).otherwise(function(e){s.error=e,e.response&&(e.status=e.response.status,e.responseText=e.response.text,e.xhr=e.response.xhr),i.reject(e)}),i},e.xhrGet=function(r){return e.xhr("GET",r)},e.rawXhrPost=e.xhrPost=function(r){return e.xhr("POST",r,!0)},e.rawXhrPut=e.xhrPut=function(r){return e.xhr("PUT",r,!0)},e.xhrDelete=function(r){return e.xhr("DELETE",r)},e._isDocumentOk=function(e){return y.checkStatus(e.status)},e._getText=function(r){var o;return e.xhrGet({url:r,sync:!0,load:function(e){o=e}}),o},c.mixin(e.xhr,{_xhrObj:e._xhrObj,fieldToObject:i.fieldToObject,formToObject:i.toObject,objectToQuery:t.objectToQuery,formToQuery:i.toQuery,formToJson:i.toJson,queryToObject:t.queryToObject,contentHandlers:m,_ioSetArgs:e._ioSetArgs,_ioCancelAll:e._ioCancelAll,_ioNotifyStart:e._ioNotifyStart,_ioWatch:e._ioWatch,_ioAddQueryToUrl:e._ioAddQueryToUrl,_isDocumentOk:e._isDocumentOk,_getText:e._getText,get:e.xhrGet,post:e.xhrPost,put:e.xhrPut,del:e.xhrDelete}),e.xhr});