define("dojox/rpc/JsonRest",["dojo","dojox","dojox/json/ref","dojox/rpc/Rest"],function(e,t){function r(e,r,n,s){var c=r.ioArgs&&r.ioArgs.xhr&&r.ioArgs.xhr.getResponseHeader("Last-Modified");c&&o._timeStamps&&(o._timeStamps[s]=c);var a=e._schema&&e._schema.hrefProperty;return a&&(t.json.ref.refAttribute=a),n=n&&t.json.ref.resolveJson(n,{defaultId:s,index:o._index,timeStamps:c&&o._timeStamps,time:c,idPrefix:e._store.allowNoTrailingSlash?e.servicePath+"/":e.servicePath.replace(/[^\/]*$/,""),idAttribute:i.getIdAttribute(e),schemas:i.schemas,loader:i._loader,idAsRef:e.idAsRef,assignAbsoluteIds:!0}),t.json.ref.refAttribute="$ref",n}var i,n=[],o=t.rpc.Rest;return i=t.rpc.JsonRest={serviceClass:t.rpc.Rest,conflictDateHeader:"If-Unmodified-Since",commit:function(t){t=t||{};for(var r=[],s={},c=[],a=0;a<n.length;a++){var d=n[a],h=d.object,f=d.old;if((!t.service||!h&&!f||!(h||f).__id.indexOf(t.service.servicePath))&&d.save){if(delete h.__isDirty,h)if(f){var u;if((u=h.__id.match(/(.*)#.*/))&&(h=o._index[u[1]]),!(h.__id in s)){if(s[h.__id]=h,t.incrementalUpdates&&!u)var l=("function"==typeof t.incrementalUpdates?t.incrementalUpdates:function(){l={};for(var e in h)if(h.hasOwnProperty(e))h[e]!==f[e]&&(l[e]=h[e]);else if(f.hasOwnProperty(e))return null;return l})(h,f);l?r.push({method:"post",target:h,content:l}):r.push({method:"put",target:h,content:h})}}else{var v=i.getServiceAndId(h.__id).service,_=i.getIdAttribute(v);_ in h&&!t.alwaysPostNewItems?r.push({method:"put",target:h,content:h}):r.push({method:"post",target:{__id:v.servicePath},content:h})}else f&&r.push({method:"delete",target:f});c.push(d),n.splice(a--,1)}}return e.connect(t,"onError",function(){if(!1!==t.revertOnError){var r=n;n=c;i.revert(),n=r}else e.forEach(c,function(e){i.changing(e.object,!e.object)})}),i.sendToServer(r,t),r},sendToServer:function(n,s){var c,a,d,h=e.xhr,f=n.length,u=this.conflictDateHeader;for(e.xhr=function(t,r){return r.headers=r.headers||{},r.headers.Transaction=n.length-1==c?"commit":"open",u&&d&&(r.headers[u]=d),a&&(r.headers["Content-ID"]="<"+a+">"),h.apply(e,arguments)},c=0;c<n.length;c++){var l=n[c];t.rpc.JsonRest._contentId=l.content&&l.content.__id;var v="post"==l.method;d="put"==l.method&&o._timeStamps[l.content.__id],d&&(o._timeStamps[l.content.__id]=new Date+""),a=v&&t.rpc.JsonRest._contentId;var _=i.getServiceAndId(l.target.__id),p=_.service,m=l.deferred=p[l.method](_.id.replace(/#/,""),t.json.ref.toJson(l.content,!1,p.servicePath,!0));!function(e,t,i){t.addCallback(function(c){try{var a=t.ioArgs.xhr&&t.ioArgs.xhr.getResponseHeader("Location");if(a){var d=a.match(/(^\w+:\/\/)/)&&a.indexOf(i.servicePath);a=d>0?a.substring(d):(i.servicePath+a).replace(/^(.*\/)?(\w+:\/\/)|[^\/\.]+\/\.\.\/|^.*\/(\/)/,"$2$3"),e.__id=a,o._index[a]=e}c=r(i,t,c,e&&e.__id)}catch(e){}return--f||s.onComplete&&s.onComplete.call(s.scope,n),c})}(l.content,m,p),m.addErrback(function(e){f=-1,s.onError.call(s.scope,e)})}e.xhr=h},getDirtyObjects:function(){return n},revert:function(e){for(var r=n.length;r>0;){r--;var i=n[r],o=i.object,s=i.old,c=t.data._getStoreForItem(o||s);if(!e||!o&&!s||!(o||s).__id.indexOf(e.servicePath)){if(o&&s){for(var a in s)s.hasOwnProperty(a)&&o[a]!==s[a]&&(c&&c.onSet(o,a,o[a],s[a]),o[a]=s[a]);for(a in o)s.hasOwnProperty(a)||(c&&c.onSet(o,a,o[a]),delete o[a])}else s?c&&c.onNew(s):c&&c.onDelete(o);delete(o||s).__isDirty,n.splice(r,1)}}},changing:function(e,t){if(e.__id){e.__isDirty=!0;for(var r=0;r<n.length;r++){var i=n[r];if(e==i.object)return void(t&&(i.object=!1,this._saveNotNeeded||(i.save=!0)))}var o=e instanceof Array?[]:{};for(r in e)e.hasOwnProperty(r)&&(o[r]=e[r]);n.push({object:!t&&e,old:o,save:!this._saveNotNeeded})}},deleteObject:function(e){this.changing(e,!0)},getConstructor:function(r,s){if("string"==typeof r){var c=r;r=new t.rpc.Rest(r,!0),this.registerService(r,c,s)}return r._constructor?r._constructor:(r._constructor=function(s){function c(e){if(e){c(e.extends),a=e.properties;for(var t in a){var r=a[t];r&&"object"==typeof r&&"default"in r&&(h[t]=r.default)}}e&&e.prototype&&e.prototype.initialize&&(d=!0,e.prototype.initialize.apply(h,f))}var a,d,h=this,f=arguments;c(r._schema),!d&&s&&"object"==typeof s&&e.mixin(h,s);var u=i.getIdAttribute(r);o._index[this.__id=this.__clientId=r.servicePath+(this[u]||Math.random().toString(16).substring(2,14)+"@"+(t.rpc.Client&&t.rpc.Client.clientId||"client"))]=this,t.json.schema&&a&&t.json.schema.mustBeValid(t.json.schema.validate(this,r._schema)),n.push({object:this,save:!0})},e.mixin(r._constructor,r._schema,{load:r}))},fetch:function(e){var t=i.getServiceAndId(e);return this.byId(t.service,t.id)},getIdAttribute:function(e){var t,r=e._schema;if(r&&!(t=r._idAttr))for(var i in r.properties)(r.properties[i].identity||"self"==r.properties[i].link)&&(r._idAttr=t=i);return t||"id"},getServiceAndId:function(e){var t="";for(var r in i.services)e.substring(0,r.length)==r&&r.length>=t.length&&(t=r);if(t)return{service:i.services[t],id:e.substring(t.length)};var n=e.match(/^(.*\/)([^\/]*)$/);return{service:new i.serviceClass(n[1],!0),id:n[2]}},services:{},schemas:{},registerService:function(e,t,r){t=e.servicePath=t||e.servicePath,e._schema=i.schemas[t]=r||e._schema||{},i.services[t]=e},byId:function(t,r){var i,n=o._index[(t.servicePath||"")+r];return n&&!n._loadObject?(i=new e.Deferred,i.callback(n),i):this.query(t,r)},query:function(e,t,i){var n=e(t,i);return n.addCallback(function(o){return o.nodeType&&o.cloneNode?o:r(e,n,o,"string"!=typeof t||i&&(i.start||i.count)?void 0:t)}),n},_loader:function(e){var t=i.getServiceAndId(this.__id),r=this;i.query(t.service,t.id).addBoth(function(t){t==r?(delete t.$ref,delete t._loadObject):r._loadObject=function(e){e(t)},e(t)})},isDirty:function(r,i){return r?r.__isDirty:i?e.some(n,function(e){return t.data._getStoreForItem(e.object||e.old)==i}):!!n.length}},t.rpc.JsonRest});