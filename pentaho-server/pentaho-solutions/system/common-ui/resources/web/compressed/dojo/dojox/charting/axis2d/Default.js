define(["dojo/_base/lang","dojo/_base/array","dojo/sniff","dojo/_base/declare","dojo/_base/connect","dojo/dom-geometry","./Invisible","../scaler/linear","./common","dojox/gfx","dojox/lang/utils","dojox/lang/functional","dojo/has!dojo-bidi?../bidi/axis2d/Default"],function(t,e,i,a,l,r,n,h,o,s,c,m,x){var b=a(i("dojo-bidi")?"dojox.charting.axis2d.NonBidiDefault":"dojox.charting.axis2d.Default",n,{defaultParams:{vertical:!1,fixUpper:"none",fixLower:"none",natural:!1,leftBottom:!0,includeZero:!1,fixed:!0,majorLabels:!0,minorTicks:!0,minorLabels:!0,microTicks:!1,rotation:0,htmlLabels:!0,enableCache:!1,dropLabels:!0,labelSizeChange:!1},optionalParams:{min:0,max:1,from:0,to:1,majorTickStep:4,minorTickStep:2,microTickStep:1,labels:[],labelFunc:null,maxLabelSize:0,maxLabelCharCount:0,trailingSymbol:null,stroke:{},majorTick:{},minorTick:{},microTick:{},tick:{},font:"",fontColor:"",title:"",titleGap:0,titleFont:"",titleFontColor:"",titleOrientation:""},constructor:function(e,i){this.opt=t.clone(this.defaultParams),c.updateWithObject(this.opt,i),c.updateWithPattern(this.opt,i,this.optionalParams),this.opt.enableCache&&(this._textFreePool=[],this._lineFreePool=[],this._textUsePool=[],this._lineUsePool=[]),this._invalidMaxLabelSize=!0},setWindow:function(t,e){return t!=this.scale&&(this._invalidMaxLabelSize=!0),this.inherited(arguments)},_groupLabelWidth:function(e,i,a){if(!e.length)return 0;e.length>50&&(e.length=50),t.isObject(e[0])&&(e=m.map(e,function(t){return t.text})),a&&(e=m.map(e,function(e){return 0==t.trim(e).length?"":e.substring(0,a)+this.trailingSymbol},this));var l=e.join("<br>");return s._base._getTextBox(l,{font:i}).w||0},_getMaxLabelSize:function(i,a,l,r,n,o){if(null==this._maxLabelSize&&6==arguments.length){var s=this.opt;this.scaler.minMinorStep=this._prevMinMinorStep=0;var c=t.clone(s);delete c.to,delete c.from;var m=h.buildScaler(i,a,l,c,s.to-s.from);m.minMinorStep=0,this._majorStart=m.major.start;var x=h.buildTicks(m,s);if(o&&x){var b=0,d=0,u=function(t){t.label&&this.push(t.label)},f=[];this.opt.majorLabels&&(e.forEach(x.major,u,f),b=this._groupLabelWidth(f,n,c.maxLabelCharCount),c.maxLabelSize&&(b=Math.min(c.maxLabelSize,b))),f=[],this.opt.dropLabels&&this.opt.minorLabels&&(e.forEach(x.minor,u,f),d=this._groupLabelWidth(f,n,c.maxLabelCharCount),c.maxLabelSize&&(d=Math.min(c.maxLabelSize,d))),this._maxLabelSize={majLabelW:b,minLabelW:d,majLabelH:o,minLabelH:o}}else this._maxLabelSize=null}return this._maxLabelSize},calculate:function(t,e,i){if(this.inherited(arguments),this.scaler.minMinorStep=this._prevMinMinorStep,(this._invalidMaxLabelSize||i!=this._oldSpan)&&t!=1/0&&e!=-1/0){this._invalidMaxLabelSize=!1,this.opt.labelSizeChange&&(this._maxLabelSize=null),this._oldSpan=i;var a=this.opt,l=this.chart.theme.axis,r=a.rotation%360,n=this.chart.theme.axis.tick.labelGap,o=a.font||l.majorTick&&l.majorTick.font||l.tick&&l.tick.font,c=o?s.normalizedLength(s.splitFontString(o).size):0,m=this._getMaxLabelSize(t,e,i,r,o,c);if("number"!=typeof n&&(n=4),m&&a.dropLabels){var x,b,d=Math.abs(Math.cos(r*Math.PI/180)),u=Math.abs(Math.sin(r*Math.PI/180));switch(r<0&&(r+=360),r){case 0:case 180:this.vertical?x=b=c:(x=m.majLabelW,b=m.minLabelW);break;case 90:case 270:this.vertical?(x=m.majLabelW,b=m.minLabelW):x=b=c;break;default:x=this.vertical?Math.min(m.majLabelW,c/d):Math.min(m.majLabelW,c/u);var f=Math.sqrt(m.minLabelW*m.minLabelW+c*c),g=this.vertical?c*d+m.minLabelW*u:m.minLabelW*d+c*u;b=Math.min(f,g)}this.scaler.minMinorStep=this._prevMinMinorStep=Math.max(x,b)+n;var p=this.scaler.minMinorStep<=this.scaler.minor.tick*this.scaler.bounds.scale;this._skipInterval=p?0:Math.floor((x+n)/(this.scaler.major.tick*this.scaler.bounds.scale))}else this._skipInterval=0}return this.ticks=h.buildTicks(this.scaler,this.opt),this},getOffsets:function(){var t=this.scaler,e={l:0,r:0,t:0,b:0};if(!t)return e;var i=this.opt,a=this.chart.theme.axis,l=this.chart.theme.axis.tick.labelGap,r=i.titleFont||a.title&&a.title.font,n=0==i.titleGap?0:i.titleGap||a.title&&a.title.gap,h=this.chart.theme.getTick("major",i),o=this.chart.theme.getTick("minor",i),c=r?s.normalizedLength(s.splitFontString(r).size):0,m=i.rotation%360,x=i.leftBottom,b=Math.abs(Math.cos(m*Math.PI/180)),d=Math.abs(Math.sin(m*Math.PI/180));this.trailingSymbol=void 0===i.trailingSymbol||null===i.trailingSymbol?this.trailingSymbol:i.trailingSymbol,"number"!=typeof l&&(l=4),m<0&&(m+=360);var u=this._getMaxLabelSize();if(u){var f,g=Math.ceil(Math.max(u.majLabelW,u.minLabelW))+1,p=Math.ceil(Math.max(u.majLabelH,u.minLabelH))+1;if(this.vertical){switch(f=x?"l":"r",m){case 0:case 180:e[f]=g,e.t=e.b=p/2;break;case 90:case 270:e[f]=p,e.t=e.b=g/2;break;default:m<=45||180<m&&m<=225?(e[f]=p*d/2+g*b,e[x?"t":"b"]=p*b/2+g*d,e[x?"b":"t"]=p*b/2):m>315||180>m&&m>135?(e[f]=p*d/2+g*b,e[x?"b":"t"]=p*b/2+g*d,e[x?"t":"b"]=p*b/2):m<90||180<m&&m<270?(e[f]=p*d+g*b,e[x?"t":"b"]=p*b+g*d):(e[f]=p*d+g*b,e[x?"b":"t"]=p*b+g*d)}e[f]+=l+Math.max(h.length>0?h.length:0,o.length>0?o.length:0)+(i.title?c+n:0)}else{switch(f=x?"b":"t",m){case 0:case 180:e[f]=p,e.l=e.r=g/2;break;case 90:case 270:e[f]=g,e.l=e.r=p/2;break;default:45<=m&&m<=90||225<=m&&m<=270?(e[f]=p*b/2+g*d,e[x?"r":"l"]=p*d/2+g*b,e[x?"l":"r"]=p*d/2):90<=m&&m<=135||270<=m&&m<=315?(e[f]=p*b/2+g*d,e[x?"l":"r"]=p*d/2+g*b,e[x?"r":"l"]=p*d/2):m<45||180<m&&m<225?(e[f]=p*b+g*d,e[x?"r":"l"]=p*d+g*b):(e[f]=p*b+g*d,e[x?"l":"r"]=p*d+g*b)}e[f]+=l+Math.max(h.length>0?h.length:0,o.length>0?o.length:0)+(i.title?c+n:0)}}return e},cleanGroup:function(t){this.opt.enableCache&&this.group&&(this._lineFreePool=this._lineFreePool.concat(this._lineUsePool),this._lineUsePool=[],this._textFreePool=this._textFreePool.concat(this._textUsePool),this._textUsePool=[]),this.inherited(arguments)},createText:function(t,e,i,a,l,r,n,h,s){if(!this.opt.enableCache||"html"==t)return o.createText[t](this.chart,e,i,a,l,r,n,h,s);var c;return this._textFreePool.length>0?(c=this._textFreePool.pop(),c.setShape({x:i,y:a,text:r,align:l}),e.add(c)):c=o.createText[t](this.chart,e,i,a,l,r,n,h),this._textUsePool.push(c),c},createLine:function(t,e){var i;return this.opt.enableCache&&this._lineFreePool.length>0?(i=this._lineFreePool.pop(),i.setShape(e),t.add(i)):i=t.createLine(e),this.opt.enableCache&&this._lineUsePool.push(i),i},render:function(t,a){var l=this._isRtl();if(!this.dirty||!this.scaler)return this;var r,n,c,m,x,b,d,u,f,g=this.opt,p=this.chart.theme.axis,y=g.leftBottom,L=g.rotation%360,k=0,M=this.chart.theme.axis.tick.labelGap,v=g.font||p.majorTick&&p.majorTick.font||p.tick&&p.tick.font,S=g.titleFont||p.title&&p.title.font,_=g.fontColor||p.majorTick&&p.majorTick.fontColor||p.tick&&p.tick.fontColor||"black",j=g.titleFontColor||p.title&&p.title.fontColor||"black",T=0==g.titleGap?0:g.titleGap||p.title&&p.title.gap||15,C=g.titleOrientation||p.title&&p.title.orientation||"axis",z=this.chart.theme.getTick("major",g),P=this.chart.theme.getTick("minor",g),W=this.chart.theme.getTick("micro",g),w="stroke"in g?g.stroke:p.stroke,F=v?s.normalizedLength(s.splitFontString(v).size):0,G=Math.abs(Math.cos(L*Math.PI/180)),I=Math.abs(Math.sin(L*Math.PI/180)),U=S?s.normalizedLength(s.splitFontString(S).size):0;"number"!=typeof M&&(M=4),L<0&&(L+=360);var E=this._getMaxLabelSize();if(E=E&&E.majLabelW,this.vertical){switch(r={y:t.height-a.b},n={y:a.t},c={y:(t.height-a.b+a.t)/2},m=F*I+(E||0)*G+M+Math.max(z.length>0?z.length:0,P.length>0?P.length:0)+U+T,x={x:0,y:-1},u={x:0,y:0},b={x:1,y:0},d={x:M,y:0},L){case 0:f="end",u.y=.4*F;break;case 90:f="middle",u.x=-F;break;case 180:f="start",u.y=.4*-F;break;case 270:f="middle";break;default:L<45?(f="end",u.y=.4*F):L<90?(f="end",u.y=.4*F):L<135?f="start":L<225?(f="start",u.y=.4*-F):L<270?(f="start",u.x=y?0:.4*F):L<315?(f="end",u.x=y?0:.4*F):(f="end",u.y=.4*F)}if(y)r.x=n.x=a.l,k=C&&"away"==C?90:270,c.x=a.l-m+(270==k?U:0),b.x=-1,d.x=-d.x;else switch(r.x=n.x=t.width-a.r,k=C&&"axis"==C?90:270,c.x=t.width-a.r+m-(270==k?0:U),f){case"start":f="end";break;case"end":f="start";break;case"middle":u.x+=F}}else{switch(r={x:a.l},n={x:t.width-a.r},c={x:(t.width-a.r+a.l)/2},m=F*G+(E||0)*I+M+Math.max(z.length>0?z.length:0,P.length>0?P.length:0)+U+T,x={x:l?-1:1,y:0},u={x:0,y:0},b={x:0,y:1},d={x:0,y:M},L){case 0:f="middle",u.y=F;break;case 90:f="start",u.x=.4*-F;break;case 180:f="middle";break;case 270:f="end",u.x=.4*F;break;default:L<45?(f="start",u.y=y?F:0):L<135?(f="start",u.x=.4*-F):L<180?(f="start",u.y=y?0:-F):L<225?(f="end",u.y=y?0:-F):L<315?(f="end",u.y=y?.4*F:0):(f="end",u.y=y?F:0)}if(y)r.y=n.y=t.height-a.b,k=C&&"axis"==C?180:0,c.y=t.height-a.b+m-(k?U:0);else switch(r.y=n.y=a.t,k=C&&"away"==C?180:0,c.y=a.t-m+(k?0:U),b.y=-1,d.y=-d.y,f){case"start":f="end";break;case"end":f="start";break;case"middle":u.y-=F}}this.cleanGroup();var B=this.group,q=this.scaler,O=this.ticks,D=h.getTransformerFromModel(this.scaler),H=g.title&&k||L||!this.opt.htmlLabels||i("ie")||i("opera")?"gfx":"html",A=b.x*z.length,R=b.y*z.length,N=this._skipInterval;if(B.createLine({x1:r.x,y1:r.y,x2:n.x,y2:n.y}).setStroke(w),g.title){var Z=o.createText[H](this.chart,B,c.x,c.y,"middle",g.title,S,j);"html"==H?this.htmlElements.push(Z):Z.setTransform(s.matrix.rotategAt(k,c.x,c.y))}if(null==O)return this.dirty=!1,this;var J=O.major.length>0?(O.major[0].value-this._majorStart)/q.major.tick:0,K=this.opt.majorLabels;return e.forEach(O.major,function(t,e){var i,a=D(t.value),h=(l?n.x:r.x)+x.x*a,o=r.y+x.y*a;if(e+=J,this.createLine(B,{x1:h,y1:o,x2:h+A,y2:o+R}).setStroke(z),t.label&&(!N||(e-(1+N))%(1+N)==0)){var c=g.maxLabelCharCount?this.getTextWithLimitCharCount(t.label,v,g.maxLabelCharCount):{text:t.label,truncated:!1};c=g.maxLabelSize?this.getTextWithLimitLength(c.text,v,g.maxLabelSize,c.truncated):c,i=this.createText(H,B,h+(z.length>0?A:0)+d.x+(L?0:u.x),o+(z.length>0?R:0)+d.y+(L?0:u.y),f,c.text,v,_),c.truncated&&this.chart.formatTruncatedLabel(i,t.label,H),c.truncated&&this.labelTooltip(i,this.chart,t.label,c.text,v,H),"html"==H?this.htmlElements.push(i):L&&i.setTransform([{dx:u.x,dy:u.y},s.matrix.rotategAt(L,h+(z.length>0?A:0)+d.x,o+(z.length>0?R:0)+d.y)])}},this),A=b.x*P.length,R=b.y*P.length,K=this.opt.minorLabels&&q.minMinorStep<=q.minor.tick*q.bounds.scale,e.forEach(O.minor,function(t){var e,i=D(t.value),a=(l?n.x:r.x)+x.x*i,h=r.y+x.y*i;if(this.createLine(B,{x1:a,y1:h,x2:a+A,y2:h+R}).setStroke(P),K&&t.label){var o=g.maxLabelCharCount?this.getTextWithLimitCharCount(t.label,v,g.maxLabelCharCount):{text:t.label,truncated:!1};o=g.maxLabelSize?this.getTextWithLimitLength(o.text,v,g.maxLabelSize,o.truncated):o,e=this.createText(H,B,a+(P.length>0?A:0)+d.x+(L?0:u.x),h+(P.length>0?R:0)+d.y+(L?0:u.y),f,o.text,v,_),o.truncated&&this.chart.formatTruncatedLabel(e,t.label,H),o.truncated&&this.labelTooltip(e,this.chart,t.label,o.text,v,H),"html"==H?this.htmlElements.push(e):L&&e.setTransform([{dx:u.x,dy:u.y},s.matrix.rotategAt(L,a+(P.length>0?A:0)+d.x,h+(P.length>0?R:0)+d.y)])}},this),A=b.x*W.length,R=b.y*W.length,e.forEach(O.micro,function(t){var e=D(t.value),i=r.x+x.x*e,a=r.y+x.y*e;this.createLine(B,{x1:i,y1:a,x2:i+A,y2:a+R}).setStroke(W)},this),this.dirty=!1,this},labelTooltip:function(e,i,a,n,h,o){var c=["dijit/Tooltip"],m={type:"rect"},x=["above","below"],b=s._base._getTextBox(n,{font:h}).w||0,d=h?s.normalizedLength(s.splitFontString(h).size):0;if("html"==o)t.mixin(m,r.position(e.firstChild,!0)),m.width=Math.ceil(b),m.height=Math.ceil(d),this._events.push({shape:dojo,handle:l.connect(e.firstChild,"onmouseover",this,function(t){require(c,function(t){t.show(a,m,x)})})}),this._events.push({shape:dojo,handle:l.connect(e.firstChild,"onmouseout",this,function(t){require(c,function(t){t.hide(m)})})});else{var u=e.getShape(),f=i.getCoords();m=t.mixin(m,{x:u.x-b/2,y:u.y}),m.x+=f.x,m.y+=f.y,m.x=Math.round(m.x),m.y=Math.round(m.y),m.width=Math.ceil(b),m.height=Math.ceil(d),this._events.push({shape:e,handle:e.connect("onmouseenter",this,function(t){require(c,function(t){t.show(a,m,x)})})}),this._events.push({shape:e,handle:e.connect("onmouseleave",this,function(t){require(c,function(t){t.hide(m)})})})}},_isRtl:function(){return!1}});return i("dojo-bidi")?a("dojox.charting.axis2d.Default",[b,x]):b});