define(["dojo/_base/declare","dojo/_base/array","dojo/_base/lang","dojo/_base/xhr"],function(t,e,i,n){var r=i.getObject("grid.enhanced.plugins",!0,dojox),s=function(t){for(var i=["reorder","sizeChange","normal","presentation"],n=i.length,r=t.length-1;r>=0;--r){var s=e.indexOf(i,t[r]);s>=0&&s<=n&&(n=s)}return n<i.length-1?i.slice(0,n+1):i},a=function(t){var e,i=this._layers,n=i.length;if(t){for(e=n-1;e>=0;--e)if(i[e].name()==t){i[e]._unwrap(i[e+1]);break}i.splice(e,1)}else for(e=n-1;e>=0;--e)i[e]._unwrap();return i.length||(delete this._layers,delete this.layer,delete this.unwrap,delete this.forEachLayer),this},o=function(t){var e,i=this._layers;if(void 0===t)return i.length;if("number"==typeof t)return i[t];for(e=i.length-1;e>=0;--e)if(i[e].name()==t)return i[e];return null},h=function(t,e){var i,n,r,s=this._layers.length;e?(i=0,n=s,r=1):(i=s-1,n=-1,r=-1);for(var a=i;a!=n;a+=r)if(!1===t(this._layers[a],a))return a;return n};r.wrap=function(t,n,r,l){t._layers||(t._layers=[],t.layer=i.hitch(t,o),t.unwrap=i.hitch(t,a),t.forEachLayer=i.hitch(t,h));var c=s(r.tags);return e.some(t._layers,function(i,s){return!e.some(i.tags,function(t){return e.indexOf(c,t)>=0})&&(t._layers.splice(s,0,r),r._wrap(t,n,l,i),!0)})||(t._layers.push(r),r._wrap(t,n,l)),t};var l=t("dojox.grid.enhanced.plugins._StoreLayer",null,{tags:["normal"],layerFuncName:"_fetch",constructor:function(){this._store=null,this._originFetch=null,this.__enabled=!0},initialize:function(t){},uninitialize:function(t){},invalidate:function(){},_wrap:function(t,e,n,r){this._store=t,this._funcName=e;var s=i.hitch(this,function(){return(this.enabled()?this[n||this.layerFuncName]:this.originFetch).apply(this,arguments)});r?(this._originFetch=r._originFetch,r._originFetch=s):(this._originFetch=t[e]||function(){},t[e]=s),this.initialize(t)},_unwrap:function(t){this.uninitialize(this._store),t?t._originFetch=this._originFetch:this._store[this._funcName]=this._originFetch,this._originFetch=null,this._store=null},enabled:function(t){return void 0!==t&&(this.__enabled=!!t),this.__enabled},name:function(){if(!this.__name){var t=this.declaredClass.match(/(?:\.(?:_*)([^\.]+)Layer$)|(?:\.([^\.]+)$)/i);this.__name=t?(t[1]||t[2]).toLowerCase():this.declaredClass}return this.__name},originFetch:function(){return i.hitch(this._store,this._originFetch).apply(this,arguments)}});return{_StoreLayer:l,_ServerSideLayer:t("dojox.grid.enhanced.plugins._ServerSideLayer",l,{constructor:function(t){t=t||{},this._url=t.url||"",this._isStateful=!!t.isStateful,this._onUserCommandLoad=t.onCommandLoad||function(){},this.__cmds={cmdlayer:this.name(),enable:!0},this.useCommands(this._isStateful)},enabled:function(t){var e=this.inherited(arguments);return this.__cmds.enable=this.__enabled,e},useCommands:function(t){return void 0!==t&&(this.__cmds.cmdlayer=t&&this._isStateful?this.name():null),!!this.__cmds.cmdlayer},_fetch:function(t){return this.__cmds.cmdlayer?n.post({url:this._url||this._store.url,content:this.__cmds,load:i.hitch(this,function(e){this.onCommandLoad(e,t),this.originFetch(t)}),error:i.hitch(this,this.onCommandError)}):(this.onCommandLoad("",t),this.originFetch(t)),t},command:function(t,e){var i=this.__cmds;return null===e?delete i[t]:void 0!==e&&(i[t]=e),i[t]},onCommandLoad:function(t,e){this._onUserCommandLoad(this.__cmds,e,t)},onCommandError:function(t){throw console.log(t),t}}),wrap:r.wrap}});