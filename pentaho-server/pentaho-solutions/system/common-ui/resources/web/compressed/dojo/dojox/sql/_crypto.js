dojo.provide("dojox.sql._crypto"),dojo.mixin(dojox.sql._crypto,{_POOL_SIZE:100,encrypt:function(r,e,o){this._initWorkerPool();var n={plaintext:r,password:e};n=dojo.toJson(n),n="encr:"+String(n),this._assignWork(n,o)},decrypt:function(r,e,o){this._initWorkerPool();var n={ciphertext:r,password:e};n=dojo.toJson(n),n="decr:"+String(n),this._assignWork(n,o)},_initWorkerPool:function(){if(!this._manager)try{this._manager=google.gears.factory.create("beta.workerpool","1.0"),this._unemployed=[],this._employed={},this._handleMessage=[];var r=this;this._manager.onmessage=function(e,o){var n=r._employed["_"+o];if(r._employed["_"+o]=void 0,r._unemployed.push("_"+o),r._handleMessage.length){var t=r._handleMessage.shift();r._assignWork(t.msg,t.callback)}n(e)};for(var e="function _workerInit(){gearsWorkerPool.onmessage = "+String(this._workerHandler)+";}",o=e+" _workerInit();",n=0;n<this._POOL_SIZE;n++)this._unemployed.push("_"+this._manager.createWorker(o))}catch(r){throw r.message||r}},_assignWork:function(r,e){if(!this._handleMessage.length&&this._unemployed.length){var o=this._unemployed.shift().substring(1);this._employed["_"+o]=e,this._manager.sendMessage(r,parseInt(o,10))}else this._handleMessage={msg:r,callback:e}},_workerHandler:function(msg,sender){function Cipher(r,e){for(var o=e.length/4-1,n=[[],[],[],[]],t=0;t<16;t++)n[t%4][Math.floor(t/4)]=r[t];n=AddRoundKey(n,e,0,4);for(var a=1;a<o;a++)n=SubBytes(n,4),n=ShiftRows(n,4),n=MixColumns(n,4),n=AddRoundKey(n,e,a,4);n=SubBytes(n,4),n=ShiftRows(n,4),n=AddRoundKey(n,e,o,4);for(var s=new Array(16),t=0;t<16;t++)s[t]=n[t%4][Math.floor(t/4)];return s}function SubBytes(r,e){for(var o=0;o<4;o++)for(var n=0;n<e;n++)r[o][n]=Sbox[r[o][n]];return r}function ShiftRows(r,e){for(var o=new Array(4),n=1;n<4;n++){for(var t=0;t<4;t++)o[t]=r[n][(t+n)%e];for(var t=0;t<4;t++)r[n][t]=o[t]}return r}function MixColumns(r,e){for(var o=0;o<4;o++){for(var n=new Array(4),t=new Array(4),a=0;a<4;a++)n[a]=r[a][o],t[a]=128&r[a][o]?r[a][o]<<1^283:r[a][o]<<1;r[0][o]=t[0]^n[1]^t[1]^n[2]^n[3],r[1][o]=n[0]^t[1]^n[2]^t[2]^n[3],r[2][o]=n[0]^n[1]^t[2]^n[3]^t[3],r[3][o]=n[0]^t[0]^n[1]^n[2]^t[3]}return r}function AddRoundKey(r,e,o,n){for(var t=0;t<4;t++)for(var a=0;a<n;a++)r[t][a]^=e[4*o+a][t];return r}function KeyExpansion(r){for(var e=r.length/4,o=e+6,n=new Array(4*(o+1)),t=new Array(4),a=0;a<e;a++){var s=[r[4*a],r[4*a+1],r[4*a+2],r[4*a+3]];n[a]=s}for(var a=e;a<4*(o+1);a++){n[a]=new Array(4);for(var i=0;i<4;i++)t[i]=n[a-1][i];if(a%e==0){t=SubWord(RotWord(t));for(var i=0;i<4;i++)t[i]^=Rcon[a/e][i]}else e>6&&a%e==4&&(t=SubWord(t));for(var i=0;i<4;i++)n[a][i]=n[a-e][i]^t[i]}return n}function SubWord(r){for(var e=0;e<4;e++)r[e]=Sbox[r[e]];return r}function RotWord(r){r[4]=r[0];for(var e=0;e<4;e++)r[e]=r[e+1];return r}function AESEncryptCtr(r,e,o){if(128!=o&&192!=o&&256!=o)return"";for(var n=o/8,t=new Array(n),a=0;a<n;a++)t[a]=255&e.charCodeAt(a);var s=Cipher(t,KeyExpansion(t));s=s.concat(s.slice(0,n-16));for(var i=new Array(16),c=(new Date).getTime(),a=0;a<4;a++)i[a]=c>>>8*a&255;for(var a=0;a<4;a++)i[a+4]=c/4294967296>>>8*a&255;for(var f=KeyExpansion(s),d=Math.ceil(r.length/16),h=new Array(d),l=0;l<d;l++){for(var u=0;u<4;u++)i[15-u]=l>>>8*u&255;for(var u=0;u<4;u++)i[15-u-4]=l/4294967296>>>8*u;for(var g=Cipher(i,f),p=l<d-1?16:(r.length-1)%16+1,v="",a=0;a<p;a++){var y=r.charCodeAt(16*l+a),_=y^g[a];v+=String.fromCharCode(_)}h[l]=escCtrlChars(v)}for(var C="",a=0;a<8;a++)C+=String.fromCharCode(i[a]);return(C=escCtrlChars(C))+"-"+h.join("-")}function AESDecryptCtr(r,e,o){if(128!=o&&192!=o&&256!=o)return"";for(var n=o/8,t=new Array(n),a=0;a<n;a++)t[a]=255&e.charCodeAt(a);var s=KeyExpansion(t),i=Cipher(t,s);i=i.concat(i.slice(0,n-16));var c=KeyExpansion(i);r=r.split("-");for(var f=new Array(16),d=unescCtrlChars(r[0]),a=0;a<8;a++)f[a]=d.charCodeAt(a);for(var h=new Array(r.length-1),l=1;l<r.length;l++){for(var u=0;u<4;u++)f[15-u]=l-1>>>8*u&255;for(var u=0;u<4;u++)f[15-u-4]=l/4294967296-1>>>8*u&255;var g=Cipher(f,c);r[l]=unescCtrlChars(r[l]);for(var p="",a=0;a<r[l].length;a++){var v=r[l].charCodeAt(a),y=v^g[a];p+=String.fromCharCode(y)}h[l-1]=p}return h.join("")}function escCtrlChars(r){return r.replace(/[\0\t\n\v\f\r\xa0!-]/g,function(r){return"!"+r.charCodeAt(0)+"!"})}function unescCtrlChars(r){return r.replace(/!\d\d?\d?!/g,function(r){return String.fromCharCode(r.slice(1,-1))})}function encrypt(r,e){return AESEncryptCtr(r,e,256)}function decrypt(r,e){return AESDecryptCtr(r,e,256)}var Sbox=[99,124,119,123,242,107,111,197,48,1,103,43,254,215,171,118,202,130,201,125,250,89,71,240,173,212,162,175,156,164,114,192,183,253,147,38,54,63,247,204,52,165,229,241,113,216,49,21,4,199,35,195,24,150,5,154,7,18,128,226,235,39,178,117,9,131,44,26,27,110,90,160,82,59,214,179,41,227,47,132,83,209,0,237,32,252,177,91,106,203,190,57,74,76,88,207,208,239,170,251,67,77,51,133,69,249,2,127,80,60,159,168,81,163,64,143,146,157,56,245,188,182,218,33,16,255,243,210,205,12,19,236,95,151,68,23,196,167,126,61,100,93,25,115,96,129,79,220,34,42,144,136,70,238,184,20,222,94,11,219,224,50,58,10,73,6,36,92,194,211,172,98,145,149,228,121,231,200,55,109,141,213,78,169,108,86,244,234,101,122,174,8,186,120,37,46,28,166,180,198,232,221,116,31,75,189,139,138,112,62,181,102,72,3,246,14,97,53,87,185,134,193,29,158,225,248,152,17,105,217,142,148,155,30,135,233,206,85,40,223,140,161,137,13,191,230,66,104,65,153,45,15,176,84,187,22],Rcon=[[0,0,0,0],[1,0,0,0],[2,0,0,0],[4,0,0,0],[8,0,0,0],[16,0,0,0],[32,0,0,0],[64,0,0,0],[128,0,0,0],[27,0,0,0],[54,0,0,0]],cmd=msg.substr(0,4),arg=msg.substr(5);if("encr"==cmd){arg=eval("("+arg+")");var plaintext=arg.plaintext,password=arg.password,results=encrypt(plaintext,password);gearsWorkerPool.sendMessage(String(results),sender)}else if("decr"==cmd){arg=eval("("+arg+")");var ciphertext=arg.ciphertext,password=arg.password,results=decrypt(ciphertext,password);gearsWorkerPool.sendMessage(String(results),sender)}}});