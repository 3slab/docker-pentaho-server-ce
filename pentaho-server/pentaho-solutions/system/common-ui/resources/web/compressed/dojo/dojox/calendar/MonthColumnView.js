define(["./ViewBase","dijit/_TemplatedMixin","./_VerticalScrollBarBase","dojo/text!./templates/MonthColumnView.html","dojo/_base/declare","dojo/_base/event","dojo/_base/lang","dojo/_base/array","dojo/_base/sniff","dojo/_base/fx","dojo/_base/html","dojo/on","dojo/dom","dojo/dom-class","dojo/dom-style","dojo/dom-geometry","dojo/dom-construct","dojo/mouse","dojo/query","dojo/i18n","dojox/html/metrics"],function(t,e,i,o,r,s,n,a,l,d,h,c,u,m,g,p,v,f,_,C,y){return r("dojox.calendar.MonthColumnView",[t,e],{baseClass:"dojoxCalendarMonthColumnView",templateString:o,viewKind:"monthColumns",_setTabIndexAttr:"domNode",renderData:null,startDate:null,columnCount:6,daySize:30,showCellLabel:!0,showHiddenItems:!0,verticalRenderer:null,percentOverlap:0,horizontalGap:4,columnHeaderFormatLength:null,gridCellDatePattern:null,roundToDay:!0,_layoutUnit:"month",_columnHeaderHandlers:null,constructor:function(){this.invalidatingProperties=["columnCount","startDate","daySize","percentOverlap","verticalRenderer","columnHeaderDatePattern","horizontalGap","scrollBarRTLPosition","itemToRendererKindFunc","layoutPriorityFunction","textDir","items","showCellLabel","showHiddenItems"],this._columnHeaderHandlers=[]},postCreate:function(){this.inherited(arguments),this.keyboardUpDownUnit="day",this.keyboardUpDownSteps=1,this.keyboardLeftRightUnit="month",this.keyboardLeftRightSteps=1,this.allDayKeyboardUpDownUnit="day",this.allDayKeyboardUpDownSteps=1,this.allDayKeyboardLeftRightUnit="month",this.allDayKeyboardLeftRightSteps=1},destroy:function(t){this._cleanupColumnHeader(),this.scrollBar&&this.scrollBar.destroy(t),this.inherited(arguments)},_scrollBar_onScroll:function(t){this.scrollContainer.scrollTop=t},buildRendering:function(){this.inherited(arguments),this.vScrollBar&&(this.scrollBar=new i({content:this.vScrollBarContent},this.vScrollBar),this.scrollBar.on("scroll",n.hitch(this,this._scrollBar_onScroll)),this._viewHandles.push(c(this.scrollContainer,f.wheel,dojo.hitch(this,this._mouseWheelScrollHander))))},postscript:function(){this.inherited(arguments),this._initialized=!0,this.invalidRendering||this.refreshRendering()},_setVerticalRendererAttr:function(t){this._destroyRenderersByKind("vertical"),this._set("verticalRenderer",t)},_createRenderData:function(){var t={};t.daySize=this.get("daySize"),t.scrollbarWidth=y.getScrollbar().w+1,t.dateLocaleModule=this.dateLocaleModule,t.dateClassObj=this.dateClassObj,t.dateModule=this.dateModule,t.dates=[],t.columnCount=this.get("columnCount");var e=this.get("startDate");null==e&&(e=new t.dateClassObj),e=this.floorToMonth(e,!1,t),this.startDate=e;for(var i=e.getMonth(),o=0,r=0;r<t.columnCount;r++){var s=[];for(t.dates.push(s);e.getMonth()==i;)s.push(e),e=t.dateModule.add(e,"day",1),e=this.floorToDay(e,!1,t);i=e.getMonth(),o<s.length&&(o=s.length)}return t.startTime=new t.dateClassObj(t.dates[0][0]),t.endTime=new t.dateClassObj(s[s.length-1]),t.endTime=t.dateModule.add(t.endTime,"day",1),t.maxDayCount=o,t.sheetHeight=t.daySize*o,this.displayedItemsInvalidated&&!this._isEditing?(this.displayedItemsInvalidated=!1,this._computeVisibleItems(t)):this.renderData&&(t.items=this.renderData.items),t},_validateProperties:function(){this.inherited(arguments),(this.columnCount<1||isNaN(this.columnCount))&&(this.columnCount=1),(this.daySize<5||isNaN(this.daySize))&&(this.daySize=5)},_setStartDateAttr:function(t){this.displayedItemsInvalidated=!0,this._set("startDate",t)},_setColumnCountAttr:function(t){this.displayedItemsInvalidated=!0,this._set("columnCount",t)},__fixEvt:function(t){return t.sheet="primary",t.source=this,t},_formatColumnHeaderLabel:function(t){var e="wide";return this.columnHeaderFormatLength&&(e=this.columnHeaderFormatLength),this.renderData.dateLocaleModule.getNames("months",e,"standAlone")[t.getMonth()]},_formatGridCellLabel:function(t,e,i){var o,r;return null==t?"":this.gridCellPattern?this.renderData.dateLocaleModule.format(t,{selector:"date",datePattern:this.gridCellDatePattern}):(r=C.getLocalization("dojo.cldr",this._calendar),o=r["dateFormatItem-d"],this.renderData.dateLocaleModule.getNames("days","abbr","standAlone")[t.getDay()].substring(0,1)+" "+this.renderData.dateLocaleModule.format(t,{selector:"date",datePattern:o}))},scrollPosition:null,scrollBarRTLPosition:"left",_setScrollPositionAttr:function(t){this._setScrollPosition(t.date,t.duration,t.easing)},_getScrollPositionAttr:function(){return{date:this.scrollContainer.scrollTop/this.daySize+1}},_setScrollPosition:function(t,e,i){t<1?t=1:t>31&&(t=31);var o=(t-1)*this.daySize;if(e){this._scrollAnimation&&this._scrollAnimation.stop();var r=Math.abs((o-this.scrollContainer.scrollTop)*e/this.renderData.sheetHeight);this._scrollAnimation=new d.Animation({curve:[this.scrollContainer.scrollTop,o],duration:r,easing:i,onAnimate:n.hitch(this,function(t){this._setScrollImpl(t)})}),this._scrollAnimation.play()}else this._setScrollImpl(o)},_setScrollImpl:function(t){this.scrollContainer.scrollTop=t,this.scrollBar&&this.scrollBar.set("value",t)},ensureVisibility:function(t,e,i,o,r){if(o=void 0==o?1:o,this.scrollable&&this.autoScroll){var s=t.getDate()-o;this.isStartOfDay(e)&&(e=this._waDojoxAddIssue(e,"day",-1));var n=e.getDate()+o,a=this.get("scrollPosition").date,l=p.getContentBox(this.scrollContainer),d=this.get("scrollPosition").date+l.h/this.daySize,h=!1,c=null;switch(i){case"start":h=s>=a&&s<=d,c=s;break;case"end":h=n>=a&&n<=d,c=n-(d-a);break;case"both":h=s>=a&&n<=d,c=s}h||this._setScrollPosition(c,r)}},scrollView:function(t){var e=this.get("scrollPosition").date+t;this._setScrollPosition(e)},_mouseWheelScrollHander:function(t){this.scrollView(t.wheelDelta>0?-1:1)},refreshRendering:function(){if(this._initialized){this._validateProperties();var t=this.renderData,e=this._createRenderData();this.renderData=e,this._createRendering(e,t),this._layoutRenderers(e)}},_createRendering:function(t,e){g.set(this.sheetContainer,"height",t.sheetHeight+"px"),this._configureScrollBar(t),this._buildColumnHeader(t,e),this._buildGrid(t,e),this._buildItemContainer(t,e)},_configureScrollBar:function(t){l("ie")&&this.scrollBar&&g.set(this.scrollBar.domNode,"width",t.scrollbarWidth+1+"px");var e=!!this.isLeftToRight()||"right"==this.scrollBarRTLPosition,i=e?"right":"left",o=e?"left":"right";this.scrollBar&&(this.scrollBar.set("maximum",t.sheetHeight),g.set(this.scrollBar.domNode,i,0),g.set(this.scrollBar.domNode,o,"auto")),g.set(this.scrollContainer,i,t.scrollbarWidth+"px"),g.set(this.scrollContainer,o,"0"),g.set(this.columnHeader,i,t.scrollbarWidth+"px"),g.set(this.columnHeader,o,"0"),this.buttonContainer&&null!=this.owner&&this.owner.currentView==this&&(g.set(this.buttonContainer,i,t.scrollbarWidth+"px"),g.set(this.buttonContainer,o,"0"))},_columnHeaderClick:function(t){s.stop(t);var e=_("td",this.columnHeaderTable).indexOf(t.currentTarget);this._onColumnHeaderClick({index:e,date:this.renderData.dates[e][0],triggerEvent:t})},_buildColumnHeader:function(t,e){var i=this.columnHeaderTable;if(i){var o=t.columnCount-(e?e.columnCount:0);8==l("ie")&&(null==this._colTableSave?this._colTableSave=n.clone(i):o<0&&(this._cleanupColumnHeader(),this.columnHeader.removeChild(i),v.destroy(i),i=n.clone(this._colTableSave),this.columnHeaderTable=i,this.columnHeader.appendChild(i),o=t.columnCount));var r,a,d,u=_("tbody",i),g=_("tr",i);if(r=1==u.length?u[0]:h.create("tbody",null,i),a=1==g.length?g[0]:v.create("tr",null,r),o>0)for(var p=0;p<o;p++){d=v.create("td",null,a);var f=[];f.push(c(d,"click",n.hitch(this,this._columnHeaderClick))),l("touch")?(f.push(c(d,"touchstart",function(t){s.stop(t),m.add(t.currentTarget,"Active")})),f.push(c(d,"touchend",function(t){s.stop(t),m.remove(t.currentTarget,"Active")}))):(f.push(c(d,"mousedown",function(t){s.stop(t),m.add(t.currentTarget,"Active")})),f.push(c(d,"mouseup",function(t){s.stop(t),m.remove(t.currentTarget,"Active")})),f.push(c(d,"mouseover",function(t){s.stop(t),m.add(t.currentTarget,"Hover")})),f.push(c(d,"mouseout",function(t){s.stop(t),m.remove(t.currentTarget,"Hover")}))),this._columnHeaderHandlers.push(f)}else{o=-o;for(var p=0;p<o;p++){d=a.lastChild,a.removeChild(d),v.destroy(d);for(var C=this._columnHeaderHandlers.pop();C.length>0;)C.pop().remove()}}_("td",i).forEach(function(e,i){e.className="",0==i?m.add(e,"first-child"):i==this.renderData.columnCount-1&&m.add(e,"last-child");var o=t.dates[i][0];this._setText(e,this._formatColumnHeaderLabel(o)),this.styleColumnHeaderCell(e,o,t)},this)}},_cleanupColumnHeader:function(){for(;this._columnHeaderHandlers.length>0;)for(var t=this._columnHeaderHandlers.pop();t.length>0;)t.pop().remove()},styleColumnHeaderCell:function(t,e,i){},_buildGrid:function(t,e){var i=this.gridTable;if(i){g.set(i,"height",t.sheetHeight+"px");var o=t.maxDayCount-(e?e.maxDayCount:0),r=o>0,s=t.columnCount-(e?e.columnCount:0);8==l("ie")&&(null==this._gridTableSave?this._gridTableSave=n.clone(i):s<0&&(this.grid.removeChild(i),v.destroy(i),i=n.clone(this._gridTableSave),this.gridTable=i,this.grid.appendChild(i),s=t.columnCount,o=t.maxDayCount,r=!0));var a,d=_("tbody",i);if(a=1==d.length?d[0]:v.create("tbody",null,i),r)for(var h=0;h<o;h++)v.create("tr",null,a);else{o=-o;for(var h=0;h<o;h++)a.removeChild(a.lastChild)}var c=t.maxDayCount-o,u=r||s>0;s=u?s:-s,_("tr",i).forEach(function(e,i){if(u)for(var o=i>=c?t.columnCount:s,i=0;i<o;i++){var r=v.create("td",null,e);v.create("span",null,r)}else for(var i=0;i<s;i++)e.removeChild(e.lastChild)}),_("tr",i).forEach(function(e,i){e.className="",0==i&&m.add(e,"first-child"),i==t.maxDayCount-1&&m.add(e,"last-child"),_("td",e).forEach(function(e,o){e.className="",0==o&&m.add(e,"first-child"),o==t.columnCount-1&&m.add(e,"last-child");var r=null;i<t.dates[o].length&&(r=t.dates[o][i]);var s=_("span",e)[0];this._setText(s,this.showCellLabel?this._formatGridCellLabel(r,i,o):null),this.styleGridCell(e,r,o,i,t)},this)},this)}},styleGridCellFunc:null,defaultStyleGridCell:function(t,e,i,o,r){null!=e&&(m.add(t,this._cssDays[e.getDay()]),this.isToday(e)?m.add(t,"dojoxCalendarToday"):this.isWeekEnd(e)&&m.add(t,"dojoxCalendarWeekend"))},styleGridCell:function(t,e,i,o,r){this.styleGridCellFunc?this.styleGridCellFunc(t,e,i,o,r):this.defaultStyleGridCell(t,e,i,o,r)},_buildItemContainer:function(t,e){var i=this.itemContainerTable;if(i){var o=[];g.set(i,"height",t.sheetHeight+"px");var r=t.columnCount-(e?e.columnCount:0);8==l("ie")&&(null==this._itemTableSave?this._itemTableSave=n.clone(i):r<0&&(this.itemContainer.removeChild(i),this._recycleItemRenderers(!0),v.destroy(i),i=n.clone(this._itemTableSave),this.itemContainerTable=i,this.itemContainer.appendChild(i),r=t.columnCount));var s,a,d,h=_("tbody",i),c=_("tr",i);if(s=1==h.length?h[0]:v.create("tbody",null,i),a=1==c.length?c[0]:v.create("tr",null,s),r>0)for(var u=0;u<r;u++)d=v.create("td",null,a),v.create("div",{className:"dojoxCalendarContainerColumn"},d);else{r=-r;for(var u=0;u<r;u++)a.removeChild(a.lastChild)}_("td>div",i).forEach(function(e,i){g.set(e,{height:t.sheetHeight+"px"}),o.push(e)},this),t.cells=o}},_overlapLayoutPass2:function(t){var e,i,o,r;for(o=t[t.length-1],i=0;i<o.length;i++)o[i].extent=1;for(e=0;e<t.length-1;e++){o=t[e];for(var i=0;i<o.length;i++)if(r=o[i],-1==r.extent){r.extent=1;for(var s=0,n=!1,a=e+1;a<t.length&&!n;a++){for(var l=t[a],d=0;d<l.length&&!n;d++){var h=l[d];r.start<h.end&&h.start<r.end&&(n=!0)}n||s++}r.extent+=s}}},_defaultItemToRendererKindFunc:function(t){return t.allDay?"vertical":Math.abs(this.renderData.dateModule.difference(t.startTime,t.endTime,"minute"))>=1440?"vertical":null},_layoutRenderers:function(t){this.hiddenEvents={},this.inherited(arguments)},_layoutInterval:function(t,e,i,o,r){var s=[],n=[];t.colW=this.itemContainer.offsetWidth/t.columnCount;for(var a=0;a<r.length;a++){var l=r[a];"vertical"==this._itemToRendererKind(l)?s.push(l):this.showHiddenItems&&n.push(l)}s.length>0&&this._layoutVerticalItems(t,e,i,o,s),n.length>0&&this._layoutBgItems(t,e,i,o,n)},_dateToYCoordinate:function(t,e,i){var o=0;if(i||0!=e.getHours()||0!=e.getMinutes())o=(e.getDate()-1)*this.renderData.daySize;else{var r=this._waDojoxAddIssue(e,"day",-1);o=this.renderData.daySize+(r.getDate()-1)*this.renderData.daySize}return o+=(60*e.getHours()+e.getMinutes())*this.renderData.daySize/1440},_layoutVerticalItems:function(t,e,i,o,r){if(null!=this.verticalRenderer){for(var s=t.cells[e],a=[],l=0;l<r.length;l++){var d=r[l],h=this.computeRangeOverlap(t,d.startTime,d.endTime,i,o),c=this._dateToYCoordinate(t,h[0],!0),u=this._dateToYCoordinate(t,h[1],!1);if(u>c){var m=n.mixin({start:c,end:u,range:h,item:d},d);a.push(m)}}var p=this.computeOverlapping(a,this._overlapLayoutPass2).numLanes,f=this.percentOverlap/100;for(l=0;l<a.length;l++){d=a[l];var _,C,y=d.lane,b=d.extent;0==f?(_=1==p?t.colW:(t.colW-(p-1)*this.horizontalGap)/p,C=y*(_+this.horizontalGap),_=1==b?_:_*b+(b-1)*this.horizontalGap,_=100*_/t.colW,C=100*C/t.colW):(_=1==p?100:100/(p-(p-1)*f),C=y*(_-f*_),_=1==b?_:_*(b-(b-1)*f));var T=this._createRenderer(d,"vertical",this.verticalRenderer,"dojoxCalendarVertical");g.set(T.container,{top:d.start+"px",left:C+"%",width:_+"%",height:d.end-d.start+1+"px"});var D=this.isItemBeingEdited(d),S=this.isItemSelected(d),H=this.isItemHovered(d),x=this.isItemFocused(d),w=T.renderer;w.set("hovered",H),w.set("selected",S),w.set("edited",D),w.set("focused",!!this.showFocus&&x),w.set("storeState",this.getItemStoreState(d)),w.set("moveEnabled",this.isItemMoveEnabled(d._item,"vertical")),w.set("resizeEnabled",this.isItemResizeEnabled(d._item,"vertical")),this.applyRendererZIndex(d,T,H,S,D,x),w.updateRendering&&w.updateRendering(_,d.end-d.start+1),v.place(T.container,s),g.set(T.container,"display","block")}}},_getCellAt:function(t,e,i){return void 0!=i&&1!=i||this.isLeftToRight()||(e=this.renderData.columnCount-1-e),this.gridTable.childNodes[0].childNodes[t].childNodes[e]},invalidateLayout:function(){_("td",this.gridTable).forEach(function(t){m.remove(t,"dojoxCalendarHiddenEvents")}),this.inherited(arguments)},_layoutBgItems:function(t,e,i,o,r){for(var s={},n=0;n<r.length;n++){var a,l=r[n],d=this.computeRangeOverlap(t,l.startTime,l.endTime,i,o),h=d[0].getDate()-1;this.isStartOfDay(d[1])?(a=this._waDojoxAddIssue(d[1],"day",-1),a=a.getDate()-1):a=d[1].getDate()-1;for(var c=h;c<=a;c++)s[c]=!0}for(var u in s)if(s[u]){var g=this._getCellAt(u,e,!1);m.add(g,"dojoxCalendarHiddenEvents")}},_sortItemsFunction:function(t,e){var i=this.dateModule.compare(t.startTime,e.startTime);return 0==i&&(i=-1*this.dateModule.compare(t.endTime,e.endTime)),this.isLeftToRight()?i:-i},getTime:function(t,e,i,o){if(null!=t){var r=p.position(this.itemContainer,!0);t.touches?(o=void 0==o?0:o,e=t.touches[o].pageX-r.x,i=t.touches[o].pageY-r.y):(e=t.pageX-r.x,i=t.pageY-r.y)}var s=p.getContentBox(this.itemContainer);this.isLeftToRight()||(e=s.w-e),e<0?e=0:e>s.w&&(e=s.w-1),i<0?i=0:i>s.h&&(i=s.h-1);var n=Math.floor(e/(s.w/this.renderData.columnCount)),a=Math.floor(i/(s.h/this.renderData.maxDayCount)),l=null;return n<this.renderData.dates.length&&a<this.renderData.dates[n].length&&(l=this.newDate(this.renderData.dates[n][a])),l},_onGridMouseUp:function(t){this.inherited(arguments),this._gridMouseDown&&(this._gridMouseDown=!1,this._onGridClick({date:this.getTime(t),triggerEvent:t}))},_onGridTouchStart:function(t){this.inherited(arguments);var e=this._gridProps;e.moved=!1,e.start=t.touches[0].screenY,e.scrollTop=this.scrollContainer.scrollTop},_onGridTouchMove:function(t){if(this.inherited(arguments),t.touches.length>1&&!this._isEditing)return void s.stop(t);if(this._gridProps&&!this._isEditing){var e={x:t.touches[0].screenX,y:t.touches[0].screenY},i=this._edProps;if(!i||i&&(Math.abs(e.x-i.start.x)>25||Math.abs(e.y-i.start.y)>25)){this._gridProps.moved=!0;var o=t.touches[0].screenY-this._gridProps.start,r=this._gridProps.scrollTop-o,n=this.itemContainer.offsetHeight-this.scrollContainer.offsetHeight;r<0?(this._gridProps.start=t.touches[0].screenY,this._setScrollImpl(0),this._gridProps.scrollTop=0):r>n?(this._gridProps.start=t.touches[0].screenY,this._setScrollImpl(n),this._gridProps.scrollTop=n):this._setScrollImpl(r)}}},_onGridTouchEnd:function(t){this.inherited(arguments);var e=this._gridProps;e&&(this._isEditing||e.moved||(e.fromItem||e.editingOnStart||this.selectFromEvent(t,null,null,!0),e.fromItem||(this._pendingDoubleTap&&this._pendingDoubleTap.grid?(this._onGridDoubleClick({date:this.getTime(this._gridProps.event),triggerEvent:this._gridProps.event}),clearTimeout(this._pendingDoubleTap.timer),delete this._pendingDoubleTap):(this._onGridClick({date:this.getTime(this._gridProps.event),triggerEvent:this._gridProps.event}),this._pendingDoubleTap={grid:!0,timer:setTimeout(n.hitch(this,function(){delete this._pendingDoubleTap}),this.doubleTapDelay)}))),this._gridProps=null)},_onColumnHeaderClick:function(t){this._dispatchCalendarEvt(t,"onColumnHeaderClick")},onColumnHeaderClick:function(t){},_onScrollTimer_tick:function(){this._setScrollImpl(this.scrollContainer.scrollTop+this._scrollProps.scrollStep)},snapUnit:"day",snapSteps:1,minDurationUnit:"day",minDurationSteps:1,liveLayout:!1,stayInView:!0,allowStartEndSwap:!0,allowResizeLessThan24H:!1})});