define(["dojo/_base/lang","dojo/_base/array","dojo/_base/declare","../plot2d/Indicator","dojo/has","../plot2d/common","../axis2d/common","dojox/gfx"],function(t,i,o,e,r){var s=function(t,i,o){var e,r=t?{x:i[0],y:o[0][0]}:{x:o[0][0],y:i[0]};return i.length>1&&(e=t?{x:i[1],y:o[1][0]}:{x:o[1][0],y:i[1]}),[r,e]},a=o("dojox.charting.action2d._IndicatorElement",e,{constructor:function(t,i){i||(i={}),this.inter=i.inter},_updateVisibility:function(t,i,o){var e="x"==o?this._hAxis:this._vAxis,r=e.getWindowScale();this.chart.setAxisWindow(e.name,r,e.getWindowOffset()+(t[o]-i[o])/r),this._noDirty=!0,this.chart.render(),this._noDirty=!1,this._initTrack()},_trackMove:function(){this._updateIndicator(this.pageCoord),this._tracker=setTimeout(t.hitch(this,this._trackMove),100)},_initTrack:function(){this._tracker||(this._tracker=setTimeout(t.hitch(this,this._trackMove),500))},stopTrack:function(){this._tracker&&(clearTimeout(this._tracker),this._tracker=null)},render:function(){if(this.isDirty()){var i=this.inter,o=i.plot,e=i.opt.vertical;this.opt.offset=i.opt.offset||(e?{x:0,y:5}:{x:5,y:0}),i.opt.labelFunc&&(this.opt.labelFunc=function(t,o,r,a,n){var h=s(e,o,r);return i.opt.labelFunc(h[0],h[1],a,n)}),i.opt.fillFunc&&(this.opt.fillFunc=function(t,o,r){var a=s(e,o,r);return i.opt.fillFunc(a[0],a[1])}),this.opt=t.delegate(i.opt,this.opt),this.pageCoord?(this.opt.values=[],this.opt.labels=this.secondCoord?"trend":"markers"):(this.opt.values=null,this.inter.onChange({})),this.hAxis=o.hAxis,this.vAxis=o.vAxis,this.inherited(arguments)}},_updateIndicator:function(){var t=this._updateCoordinates(this.pageCoord,this.secondCoord);if(!(t.length>1))return void this.inter.onChange({});var o=this.opt.vertical;this._data=[],this.opt.values=[],i.forEach(t,function(t){t&&(this.opt.values.push(o?t.x:t.y),this._data.push([o?t.y:t.x]))},this),this.inherited(arguments)},_renderText:function(t,i,o,e,r,a,n,h){this.inter.opt.labels&&this.inherited(arguments);var c=s(this.opt.vertical,n,h);this.inter.onChange({start:c[0],end:c[1],label:i})},_updateCoordinates:function(t,i){r("dojo-bidi")&&this._checkXCoords(t,i);var o=this.inter,e=o.plot,s=o.opt.vertical,a=this.chart.getAxis(e.hAxis),n=this.chart.getAxis(e.vAxis),h=a.name,c=n.name,u=a.getScaler().bounds,l=n.getScaler().bounds,d=s?"x":"y",f=s?h:c,p=s?u:l;if(i){var v;s?t.x>i.x&&(v=i,i=t,t=v):t.y>i.y&&(v=i,i=t,t=v)}var x,_=e.toData(t);i&&(x=e.toData(i));var y={};y[h]=u.from,y[c]=l.from;var m=e.toPage(y);y[h]=u.to,y[c]=l.to;var g=e.toPage(y);if(_[f]<p.from){if(!x&&o.opt.autoScroll&&!o.opt.mouseOver)return this._updateVisibility(t,m,d),[];if(o.opt.mouseOver)return[];t[d]=m[d],_=e.toData(t)}else if(_[f]>p.to){if(!x&&o.opt.autoScroll&&!o.opt.mouseOver)return this._updateVisibility(t,g,d),[];if(o.opt.mouseOver)return[];t[d]=g[d],_=e.toData(t)}var b,k=this._snapData(_,d,s);return null==k.y?[]:(i&&(x[f]<p.from?(i[d]=m[d],x=e.toData(i)):x[f]>p.to&&(i[d]=g[d],x=e.toData(i)),b=this._snapData(x,d,s),null==b.y&&(b=null)),[k,b])},_snapData:function(t,i,o){var e,r,s=this.chart.getSeries(this.inter.opt.series).data,a=s.length;for(e=0;e<a;++e)if(null==(r=s[e]));else if("number"==typeof r){if(e+1>t[i])break}else if(r[i]>t[i])break;var n,h,c,u;if("number"==typeof r?(n=e+1,h=r,e>0&&(c=e,u=s[e-1])):(n=r.x,h=r.y,e>0&&(c=s[e-1].x,u=s[e-1].y)),e>0){var l=o?(n+c)/2:(h+u)/2;t[i]<=l&&(n=c,h=u)}return{x:n,y:h}},cleanGroup:function(t){return this.inherited(arguments),this.group.moveToFront(),this},isDirty:function(){return!this._noDirty&&(this.dirty||this.inter.plot.isDirty())}});return r("dojo-bidi")&&a.extend({_checkXCoords:function(t,i){this.chart.isRightToLeft()&&(t&&(t.x=this.chart.dim.width+(this.chart.offsets.l-this.chart.offsets.r)-t.x),i&&(i.x=this.chart.dim.width+(this.chart.offsets.l-this.chart.offsets.r)-i.x))}}),a});